<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS MCO</title>
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <header style="position: relative;">
            <h1>üñ•Ô∏è Gestionnaire d'Affichage Multi-√âcrans</h1>
            <p class="subtitle">Contr√¥lez tous vos √©crans depuis une seule interface</p>
            <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; align-items: flex-end; flex-direction: column;">
                <button id="update-badge" onclick="openUpdateModal()" style="display: none; background: #28a745; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); gap: 8px; align-items: center;" title="Mise √† jour disponible">
                    üîÑ Mise √† jour disponible
                </button>
                <button onclick="openSettingsModal()" style="background: #667eea; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;" title="Param√®tres">
                    ‚öôÔ∏è Param√®tres
                </button>
            </div>
        </header>

        <!-- Modal Gestion Globale Playlists -->
        <div id="global-playlist-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìã Gestion des Playlists</h2>
                    <button class="close-modal" onclick="closeGlobalPlaylistModal()">&times;</button>
                </div>
                <div class="content-form">
                    <button class="btn" onclick="openCreatePlaylistModal()" style="margin-bottom: 20px;">+ Cr√©er une Playlist</button>
                    
                    <div id="playlists-list" class="content-list"></div>
                </div>
            </div>
        </div>

        <!-- Modal Cr√©er/√âditer Playlist -->
        <div id="edit-playlist-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="edit-playlist-title">üìã Cr√©er une Playlist</h2>
                    <button class="close-modal" onclick="closeEditPlaylistModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="edit-playlist-id">
                    <div class="form-group">
                        <label>Nom de la playlist</label>
                        <input type="text" id="edit-playlist-name" placeholder="Ex: Playlist Accueil">
                    </div>
                    <div class="form-group">
                        <label>Ajouter des contenus</label>
                        <select id="edit-playlist-content-select" onchange="updateSelectedContentInfo()">
                            <option value="">Choisir un contenu...</option>
                        </select>
                        <div id="selected-content-info" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                            <div style="font-size: 0.9em; color: #333;">
                                <strong>Dur√©e:</strong> <span id="selected-content-duration">--</span>
                            </div>
                        </div>
                        <button class="btn" onclick="addToEditPlaylist()" style="margin-top: 10px; width: 100%;">+ Ajouter √† la playlist</button>
                    </div>
                    <div class="form-group">
                        <label>Contenus de la playlist</label>
                        <div id="edit-playlist-items" class="playlist-preview">
                            <p style="text-align: center; color: #999;">Aucun contenu ajout√©</p>
                        </div>
                    </div>
                    <button class="btn btn-playlist" onclick="saveEditedPlaylist()">üíæ Sauvegarder la Playlist</button>
                </div>
            </div>
        </div>

        <!-- Modal Ajouter/√âditer Contenu -->
        <div id="content-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="content-modal-title">üé¨ Ajouter un Contenu</h2>
                    <button class="close-modal" onclick="closeContentModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="content-id">
                    <div class="form-group">
                        <label>Nom du contenu</label>
                        <input type="text" id="content-name" placeholder="Ex: Page d'accueil">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="content-type">
                            <option value="url">Page Web (URL)</option>
                            <option value="video">Vid√©o (URL)</option>
                            <option value="image">Image (URL)</option>
                            <option value="youtube">YouTube</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>URL / Lien</label>
                        <input type="text" id="content-url" placeholder="https://..." onblur="handleYoutubeUrl()">
                        <div id="youtube-loading" style="display: none; color: #667eea; margin-top: 8px; font-size: 0.9em;">
                            üîÑ R√©cup√©ration des m√©tadonn√©es YouTube...
                        </div>
                        <div id="youtube-error" style="display: none; color: #dc3545; margin-top: 8px; font-size: 0.9em;"></div>
                    </div>
                    <div class="form-group">
                        <label>Dur√©e d'affichage (obligatoire)</label>
                        <input type="text" id="content-duration" value="00:00:10" placeholder="HH:MM:SS ou 1h 30m 45s" oninput="validateDuration()">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            Formats accept√©s: <code>01:30:45</code>, <code>1h 30m 45s</code>, <code>90</code> (secondes)
                        </p>
                        <div id="duration-error" style="display: none; color: #dc3545; margin-top: 8px; font-size: 0.9em; font-weight: bold;">
                            ‚ö†Ô∏è La dur√©e doit √™tre sup√©rieure √† 0. Une dur√©e infinie n'est pas permise pour les contenus.
                        </div>
                    </div>
                    <button class="btn" onclick="saveContent()">üíæ Sauvegarder</button>
                </div>
            </div>
        </div>

        <!-- Modal Configuration √âcran -->
        <div id="screen-config-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Configuration de l'√âcran</h2>
                    <button class="close-modal" onclick="closeScreenConfigModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="config-screen-id">

                    <h3 style="color: #667eea; margin-bottom: 15px;">Contenu par d√©faut</h3>
                    <div class="form-group">
                        <label>Contenu √† afficher quand rien n'est planifi√©</label>
                        <select id="config-default-content">
                            <option value="">Aucun (√©cran vide)</option>
                        </select>
                    </div>

                    <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 30px;">Comportement entre les plages horaires</h3>
                    <div class="form-group">
                        <label>Que faire entre les plages horaires planifi√©es ?</label>
                        <select id="config-idle-behavior">
                            <option value="show_default">Afficher le contenu par d√©faut</option>
                            <option value="continue_last">Continuer la derni√®re playlist</option>
                        </select>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            ‚Ä¢ <strong>Afficher le contenu par d√©faut</strong> : Retourne au contenu par d√©faut d√®s qu'une plage horaire se termine<br>
                            ‚Ä¢ <strong>Continuer la derni√®re playlist</strong> : La playlist reste en boucle jusqu'√† la prochaine plage horaire
                        </p>
                    </div>

                    <button class="btn" onclick="saveScreenConfig()">üíæ Sauvegarder la Configuration</button>
                </div>
            </div>
        </div>

        <!-- Modal Debug √âcran -->
        <div id="debug-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üêõ Debug - <span id="debug-screen-name">√âcran</span></h2>
                    <button class="close-modal" onclick="closeDebugModal()">&times;</button>
                </div>
                <div class="content-form">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">üìä √âtat actuel</strong>
                            <div style="margin-top: 8px; line-height: 1.8;">
                                <div>üîå Statut: <span id="debug-status" style="font-weight: bold;">--</span></div>
                                <div>üì∫ Contenu actuel: <span id="debug-current-content">--</span></div>
                                <div>üìã Playlist active: <span id="debug-playlist">--</span></div>
                                <div>‚è±Ô∏è Index playlist: <span id="debug-playlist-index">--</span></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">‚è∞ Temporisation</strong>
                            <div style="margin-top: 8px; line-height: 1.8;">
                                <div>‚è≤Ô∏è Temps √©coul√©: <span id="debug-elapsed-time">--</span></div>
                                <div>‚è≥ Dur√©e totale: <span id="debug-total-duration">--</span></div>
                                <div>üìÖ Derni√®re activit√©: <span id="debug-last-seen">--</span></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">üåê R√©seau</strong>
                            <div style="margin-top: 8px; line-height: 1.8;">
                                <div>üÜî ID √âcran: <span id="debug-screen-id">--</span></div>
                                <div>üìç Emplacement: <span id="debug-location">--</span></div>
                                <div>üîó Socket ID: <span id="debug-socket-id">--</span></div>
                            </div>
                        </div>

                        <div>
                            <strong style="color: #667eea;">üìÖ Planning actif</strong>
                            <div id="debug-schedule" style="margin-top: 8px; line-height: 1.8;">
                                --
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; color: #999; font-size: 0.85em;">
                        ‚ÑπÔ∏è Les donn√©es se rafra√Æchissent automatiquement toutes les 2 secondes
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Planificateur -->
        <div id="scheduler-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÖ Planifier l'√âcran</h2>
                    <button class="close-modal" onclick="closeSchedulerModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="scheduler-screen-id">

                    <h3 style="color: #667eea; margin-bottom: 15px;">Planning actuel</h3>
                    <div id="current-schedule-list" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background: #fafafa;"></div>

                    <h3 id="scheduler-form-title" style="color: #667eea; margin-bottom: 15px;">Ajouter une plage horaire</h3>
                    <div class="form-group">
                        <label>Playlist √† afficher</label>
                        <select id="scheduler-playlist-select"></select>
                    </div>
                    <div class="form-group">
                        <label>Heure de d√©but</label>
                        <input type="time" id="scheduler-start">
                    </div>
                    <div class="form-group">
                        <label>Heure de fin</label>
                        <input type="time" id="scheduler-end">
                    </div>
                    <button id="scheduler-submit-btn" class="btn" onclick="saveScheduleEntry()">+ Ajouter au Planning</button>
                    <button id="scheduler-cancel-edit-btn" class="btn" onclick="cancelScheduleEdit()" style="display: none; margin-top: 10px; background: #6c757d;">‚úñÔ∏è Annuler la modification</button>
                </div>
            </div>
        </div>

        <!-- Modal Param√®tres -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Param√®tres</h2>
                    <button class="close-modal" onclick="closeSettingsModal()">&times;</button>
                </div>
                <div class="content-form">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Configuration YouTube API</h3>
                    <div class="form-group">
                        <label>Cl√© API YouTube</label>
                        <input type="text" id="settings-youtube-api-key" placeholder="Entrez votre cl√© API YouTube">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            Cette cl√© permet de r√©cup√©rer automatiquement les m√©tadonn√©es (titre, dur√©e) des vid√©os YouTube.<br>
                            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #667eea;">Obtenir une cl√© API YouTube</a>
                        </p>
                    </div>

                    <div id="settings-api-status" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;">
                        <strong id="settings-api-status-text"></strong>
                    </div>

                    <button class="btn" onclick="saveSettings()">üíæ Sauvegarder</button>
                </div>
            </div>
        </div>

        <!-- Modal Mise √† jour -->
        <div id="update-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üîÑ Mise √† jour syst√®me</h2>
                    <button class="close-modal" onclick="closeUpdateModal()">&times;</button>
                </div>
                <div class="content-form">
                    <div id="update-info-container" style="margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #667eea;">üìä √âtat actuel</strong>
                            </div>
                            <div style="line-height: 1.8;">
                                <div>üìç Commit actuel: <code id="update-current-commit">--</code></div>
                                <div id="update-remote-info" style="display: none;">
                                    <div>üåê Commit distant: <code id="update-remote-commit">--</code></div>
                                    <div>üì¶ Commits en retard: <strong id="update-commits-behind" style="color: #dc3545;">--</strong></div>
                                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #667eea;">
                                        <strong>Dernier commit:</strong><br>
                                        <span id="update-latest-message" style="font-style: italic; color: #666;">--</span>
                                    </div>
                                </div>
                                <div id="update-uptodate-info" style="display: none; color: #28a745; font-weight: bold; margin-top: 10px;">
                                    ‚úÖ Vous √™tes √† jour !
                                </div>
                            </div>
                        </div>

                        <div id="update-error-container" style="display: none; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>‚ö†Ô∏è Erreur:</strong>
                            <div id="update-error-message" style="margin-top: 8px;"></div>
                        </div>

                        <div id="update-status-container" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong id="update-status-text"></strong>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="checkForUpdates()" id="update-check-btn">üîç V√©rifier les mises √† jour</button>
                        <button class="btn" onclick="applyUpdate()" id="update-apply-btn" style="display: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">‚¨áÔ∏è Installer la mise √† jour</button>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 3px solid #ffc107;">
                        <strong style="color: #856404;">‚ÑπÔ∏è Note importante:</strong>
                        <div style="font-size: 0.9em; color: #856404; margin-top: 5px;">
                            Apr√®s une mise √† jour, il est recommand√© de red√©marrer le serveur pour appliquer tous les changements.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reste du HTML identique... -->
        <div class="main-content">
            <div class="section" style="grid-column: 1 / -1;">
                <div class="section-header">
                    <h2>üì∫ √âcrans Connect√©s</h2>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-screens">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="online-screens">0</div>
                        <div class="stat-label">En ligne</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="content-count">0</div>
                        <div class="stat-label">Contenus</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="playlist-count">0</div>
                        <div class="stat-label">Playlists</div>
                    </div>
                </div>
                <div class="screen-grid" id="screens-container"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>üìã Playlists</h2>
                    <button class="btn btn-header" onclick="openCreatePlaylistModal()">+ Ajouter</button>
                </div>
                <div id="playlists-summary" class="content-list"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>üìö Biblioth√®que</h2>
                    <button class="btn btn-header" onclick="openAddContentModal()">+ Ajouter</button>
                </div>
                <div class="content-list" id="content-library"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let screens = {};
        let contentLibrary = [];
        let playlists = {};
        let schedules = {};
        let editingPlaylist = [];
        let editingScheduleEntry = null; // {screenId, index} quand on √©dite une entr√©e

        // Fonctions de conversion de dur√©e
        function secondsToHMS(seconds) {
            if (seconds === 0) return '‚àû (infini)';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;

            const parts = [];
            if (h > 0) parts.push(`${h}h`);
            if (m > 0) parts.push(`${m}m`);
            if (s > 0 || parts.length === 0) parts.push(`${s}s`);

            return parts.join(' ');
        }

        function hmsToSeconds(hms) {
            if (!hms || hms === '' || hms === '0') return 0;

            // Format accept√©s: "1:30:45", "90:45", "45", "1h 30m 45s", "1h30m45s"
            let totalSeconds = 0;

            // Si c'est d√©j√† un nombre simple
            if (/^\d+$/.test(hms)) {
                return parseInt(hms);
            }

            // Format avec h, m, s
            const hMatch = hms.match(/(\d+)h/);
            const mMatch = hms.match(/(\d+)m/);
            const sMatch = hms.match(/(\d+)s/);

            if (hMatch || mMatch || sMatch) {
                if (hMatch) totalSeconds += parseInt(hMatch[1]) * 3600;
                if (mMatch) totalSeconds += parseInt(mMatch[1]) * 60;
                if (sMatch) totalSeconds += parseInt(sMatch[1]);
                return totalSeconds;
            }

            // Format HH:MM:SS ou MM:SS ou SS
            const parts = hms.split(':').map(p => parseInt(p) || 0);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 1) {
                return parts[0];
            }

            return 0;
        }

        function getContentTypeIcon(type) {
            const icons = {
                'url': '<i class="fas fa-globe"></i>',
                'video': '<i class="fas fa-video"></i>',
                'image': '<i class="fas fa-image"></i>',
                'youtube': '<i class="fab fa-youtube"></i>'
            };
            return icons[type] || '<i class="fas fa-file"></i>';
        }

        function getContentTypeText(type) {
            const types = {
                'url': 'Url',
                'video': 'Vid√©o',
                'image': 'Image',
                'youtube': 'YouTube'
            };
            return types[type] || type;
        }

        function truncateText(text, maxLength = 25) {
            if (!text) return text;
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function secondsToTimeInput(seconds) {
            if (seconds === 0) return '00:00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function timeInputToSeconds(timeStr) {
            if (!timeStr || timeStr === '00:00:00') return 0;
            const parts = timeStr.split(':').map(p => parseInt(p) || 0);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        socket.on('connect', () => {
            console.log('Connect√© au serveur');
            socket.emit('get_state');
        });

        socket.on('state_update', (data) => {
            screens = data.screens;
            contentLibrary = data.content;
            playlists = data.playlists || {};
            schedules = data.schedules || {};
            updateUI();
        });

        function updateUI() {
            updateStats();
            updateScreens();
            updateContentLibrary();
            updatePlaylistsSummary();
        }

        function updateStats() {
            const total = Object.keys(screens).length;
            const online = Object.values(screens).filter(s => s.status === 'online').length;
            document.getElementById('total-screens').textContent = total;
            document.getElementById('online-screens').textContent = online;
            document.getElementById('content-count').textContent = contentLibrary.length;
            document.getElementById('playlist-count').textContent = Object.keys(playlists).length;
        }

        function updateScreens() {
            const container = document.getElementById('screens-container');

            // Sauvegarder quel menu est ouvert avant de tout recr√©er
            let openMenuId = null;
            const openMenu = document.querySelector('.screen-context-menu.active');
            if (openMenu) {
                openMenuId = openMenu.id.replace('screen-menu-', '');
            }

            container.innerHTML = '';

            for (const [id, screen] of Object.entries(screens)) {
                const card = document.createElement('div');
                card.className = `screen-card ${screen.status}`;
                card.innerHTML = `
                    <div style="position: relative;">
                        <div class="screen-name" title="${screen.name}">${truncateText(screen.name, 20)}</div>
                        <button onclick="toggleScreenMenu(event, '${id}')" class="screen-menu-btn" title="Options">
                            ‚ãÆ
                        </button>
                        <div id="screen-menu-${id}" class="screen-context-menu">
                            <div class="menu-item" onclick="refreshScreen('${id}')">
                                üîÑ Rafra√Æchir
                            </div>
                            <div class="menu-item" onclick="closeScreenMenu('${id}'); openDebugModal('${id}')">
                                üêõ Debug
                            </div>
                            <div class="menu-item" onclick="closeScreenMenu('${id}'); openScreenConfig('${id}')">
                                ‚öôÔ∏è Configurer
                            </div>
                            <div class="menu-item" onclick="closeScreenMenu('${id}'); openScheduler('${id}')">
                                üìÖ Planning
                            </div>
                        </div>
                    </div>
                    <span class="screen-status status-${screen.status}">
                        ${screen.status === 'online' ? 'üü¢ En ligne' : 'üî¥ Hors ligne'}
                    </span>
                    <div class="screen-info" title="${screen.location}">üìç ${truncateText(screen.location, 20)}</div>
                    <div class="screen-info" title="${screen.current_playlist || 'Aucune en cours'}">üìã Playlist: ${truncateText(screen.current_playlist || 'Aucune en cours', 15)}</div>
                    <div class="screen-info" title="${screen.current_content || 'Aucun en cours'}">üé¨ Contenu: ${truncateText(screen.current_content || 'Aucun en cours', 15)}</div>
                `;
                container.appendChild(card);
            }

            // Restaurer le menu ouvert si il y en avait un
            if (openMenuId) {
                const menuToReopen = document.getElementById(`screen-menu-${openMenuId}`);
                if (menuToReopen) {
                    menuToReopen.classList.add('active');
                }
            }
        }

        function updateContentLibrary() {
            const container = document.getElementById('content-library');
            container.innerHTML = '';

            if (contentLibrary.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Aucun contenu</p>';
                return;
            }

            contentLibrary.forEach(content => {
                const item = document.createElement('div');
                item.className = 'content-item';
                const truncatedUrl = content.url.length > 25 ? content.url.substring(0, 25) + '...' : content.url;
                item.innerHTML = `
                    <div style="flex: 1;">
                        <strong title="${content.name}">${content.name}</strong>
                        <span class="content-type">${getContentTypeText(content.type)}</span>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            <span title="${content.url}">üîó ${truncatedUrl}</span> | ‚è±Ô∏è ${secondsToHMS(content.duration)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-edit" onclick="editContent('${content.id}')">‚úèÔ∏è √âditer</button>
                        <button class="btn btn-danger" onclick="deleteContent('${content.id}')" style="width: auto; padding: 8px 20px;">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updatePlaylistsSummary() {
            const container = document.getElementById('playlists-summary');
            container.innerHTML = '';

            const playlistsArray = Object.values(playlists);
            if (playlistsArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Aucune playlist cr√©√©e</p>';
                return;
            }

            playlistsArray.forEach(playlist => {
                const item = document.createElement('div');
                item.className = 'content-item';

                let totalDuration = playlist.items.reduce((sum, item) => sum + item.duration, 0);
                const truncatedName = truncateText(playlist.name, 20);

                item.innerHTML = `
                    <div style="flex: 1;">
                        <strong title="${playlist.name}">${truncatedName}</strong>
                        <span class="content-type">${playlist.items.length} contenus</span>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            ‚è±Ô∏è ${secondsToHMS(totalDuration)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-edit" onclick="editPlaylist('${playlist.id}')">‚úèÔ∏è √âditer</button>
                        <button class="btn btn-danger" onclick="deletePlaylist('${playlist.id}')" style="width: auto; padding: 8px 20px;">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // GESTION DES PLAYLISTS

        function openCreatePlaylistModal() {
            document.getElementById('edit-playlist-title').textContent = 'üìã Cr√©er une Playlist';
            document.getElementById('edit-playlist-id').value = '';
            document.getElementById('edit-playlist-name').value = '';
            editingPlaylist = [];
            updateEditPlaylistPreview();
            updateEditPlaylistContentSelect();
            document.getElementById('edit-playlist-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function editPlaylist(playlistId) {
            const playlist = playlists[playlistId];
            document.getElementById('edit-playlist-title').textContent = '‚úèÔ∏è √âditer la Playlist';
            document.getElementById('edit-playlist-id').value = playlistId;
            document.getElementById('edit-playlist-name').value = playlist.name;
            editingPlaylist = [...playlist.items];
            updateEditPlaylistPreview();
            updateEditPlaylistContentSelect();
            document.getElementById('edit-playlist-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeEditPlaylistModal() {
            document.getElementById('edit-playlist-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function updateEditPlaylistContentSelect() {
            const select = document.getElementById('edit-playlist-content-select');
            select.innerHTML = '<option value="">Choisir un contenu...</option>';
            contentLibrary.forEach(content => {
                const option = document.createElement('option');
                option.value = content.id;
                option.textContent = `${truncateText(content.name, 30)} (${getContentTypeText(content.type)})`;
                select.appendChild(option);
            });
            // R√©initialiser l'affichage des infos
            document.getElementById('selected-content-info').style.display = 'none';
        }

        function updateSelectedContentInfo() {
            const contentId = document.getElementById('edit-playlist-content-select').value;
            const infoDiv = document.getElementById('selected-content-info');
            const durationSpan = document.getElementById('selected-content-duration');

            if (!contentId) {
                infoDiv.style.display = 'none';
                return;
            }

            const content = contentLibrary.find(c => c.id === contentId);
            if (!content) return;

            durationSpan.textContent = secondsToHMS(content.duration);
            infoDiv.style.display = 'block';
        }

        function addToEditPlaylist() {
            const contentId = document.getElementById('edit-playlist-content-select').value;

            if (!contentId) {
                alert('Veuillez s√©lectionner un contenu');
                return;
            }

            const content = contentLibrary.find(c => c.id === contentId);
            if (!content) return;

            // Utiliser la dur√©e du contenu
            const duration = content.duration;

            if (duration <= 0) {
                alert('Ce contenu a une dur√©e infinie (0). Veuillez d√©finir une dur√©e dans la biblioth√®que avant de l\'ajouter √† une playlist.');
                return;
            }

            editingPlaylist.push({
                content: content,
                duration: duration
            });

            updateEditPlaylistPreview();
            document.getElementById('edit-playlist-content-select').value = '';
            // Cacher l'info du contenu s√©lectionn√©
            document.getElementById('selected-content-info').style.display = 'none';
        }

        function removeFromEditPlaylist(index) {
            editingPlaylist.splice(index, 1);
            updateEditPlaylistPreview();
        }

        function updateEditPlaylistPreview() {
            const container = document.getElementById('edit-playlist-items');

            if (editingPlaylist.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Aucun contenu ajout√©</p>';
                return;
            }

            let totalDuration = 0;
            container.innerHTML = '';

            editingPlaylist.forEach((item, index) => {
                totalDuration += item.duration;
                const div = document.createElement('div');
                div.className = 'playlist-item';
                div.style.cssText = 'background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea;';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <strong title="${item.content.name}">${index + 1}. ${item.content.name}</strong>
                        <span class="content-type">${getContentTypeText(item.content.type)}</span>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            ‚è±Ô∏è ${secondsToHMS(item.duration)}
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeFromEditPlaylist(${index})" style="width: auto; padding: 8px 20px;">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });

            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 15px; padding: 10px; background: #667eea; color: white; border-radius: 8px; text-align: center; font-weight: bold;';
            summary.innerHTML = `üìä ${editingPlaylist.length} contenu(s) | Dur√©e totale: ${secondsToHMS(totalDuration)}`;
            container.appendChild(summary);
        }

        function saveEditedPlaylist() {
            const playlistId = document.getElementById('edit-playlist-id').value;
            const playlistName = document.getElementById('edit-playlist-name').value;

            if (!playlistName) {
                alert('Veuillez donner un nom √† la playlist');
                return;
            }

            if (editingPlaylist.length === 0) {
                alert('Veuillez ajouter au moins un contenu');
                return;
            }

            if (playlistId) {
                // Modification
                socket.emit('update_playlist', {
                    id: playlistId,
                    name: playlistName,
                    items: editingPlaylist
                });
            } else {
                // Cr√©ation
                socket.emit('create_playlist', {
                    name: playlistName,
                    items: editingPlaylist
                });
            }

            closeEditPlaylistModal();
        }

        function deletePlaylist(playlistId) {
            const playlist = playlists[playlistId];
            if (confirm(`Supprimer la playlist "${playlist.name}" ?`)) {
                socket.emit('delete_playlist', { playlist_id: playlistId });
            }
        }

        // MENU CONTEXTUEL √âCRAN

        function toggleScreenMenu(event, screenId) {
            event.stopPropagation();

            // Fermer tous les autres menus
            document.querySelectorAll('.screen-context-menu').forEach(menu => {
                if (menu.id !== `screen-menu-${screenId}`) {
                    menu.classList.remove('active');
                }
            });

            // Toggle le menu actuel
            const menu = document.getElementById(`screen-menu-${screenId}`);
            menu.classList.toggle('active');
        }

        function closeScreenMenu(screenId) {
            const menu = document.getElementById(`screen-menu-${screenId}`);
            if (menu) {
                menu.classList.remove('active');
            }
        }

        function refreshScreen(screenId) {
            const screen = screens[screenId];
            if (screen && screen.status === 'online') {
                if (confirm(`Rafra√Æchir l'√©cran "${screen.name}" ?\n\nCela rechargera la page sur l'√©cran distant.`)) {
                    socket.emit('reload_screen', { screen_id: screenId });
                }
            } else {
                alert('L\'√©cran doit √™tre en ligne pour √™tre rafra√Æchi.');
            }

            // Fermer le menu
            document.getElementById(`screen-menu-${screenId}`).classList.remove('active');
        }

        function restartService() {

            fetch('/restart-service', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Red√©marrage du service lanc√© !\n\n${data.message}\n\nLe service va red√©marrer dans quelques secondes.\nVous serez d√©connect√© puis reconnect√© automatiquement.`);

                    // Attendre quelques secondes puis recharger la page du manager
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                } else {
                    alert(`‚ùå Erreur lors du red√©marrage du service :\n\n${data.error}\n\nVous pouvez red√©marrer manuellement avec :\nsudo systemctl restart digital-signage.service`);
                }
            })
            .catch(error => {
                alert(`‚ùå Erreur de connexion :\n\n${error.message}`);
            });
        }

        // Fermer les menus en cliquant ailleurs
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.screen-menu-btn')) {
                document.querySelectorAll('.screen-context-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });

        // CONFIGURATION √âCRAN

        function openScreenConfig(screenId) {
            const screen = screens[screenId];
            document.getElementById('config-screen-id').value = screenId;

            // Remplir la liste des contenus disponibles
            const select = document.getElementById('config-default-content');
            select.innerHTML = '<option value="">Aucun (√©cran vide)</option>';
            contentLibrary.forEach(content => {
                const option = document.createElement('option');
                option.value = content.id;
                option.textContent = `${truncateText(content.name, 30)} (${getContentTypeText(content.type)})`;
                if (screen.default_content_id === content.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // D√©finir le comportement actuel
            document.getElementById('config-idle-behavior').value = screen.idle_behavior || 'show_default';

            document.getElementById('screen-config-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeScreenConfigModal() {
            document.getElementById('screen-config-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function saveScreenConfig() {
            const screenId = document.getElementById('config-screen-id').value;
            const defaultContentId = document.getElementById('config-default-content').value || null;
            const idleBehavior = document.getElementById('config-idle-behavior').value;

            socket.emit('update_screen_config', {
                screen_id: screenId,
                default_content_id: defaultContentId,
                idle_behavior: idleBehavior
            });

            closeScreenConfigModal();
        }

        // PLANIFICATEUR

        function openScheduler(screenId) {
            document.getElementById('scheduler-screen-id').value = screenId;
            cancelScheduleEdit(); // R√©initialiser le mode √©dition
            updateSchedulerPlaylistSelect();
            updateCurrentSchedule(screenId);
            document.getElementById('scheduler-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeSchedulerModal() {
            cancelScheduleEdit(); // R√©initialiser le mode √©dition √† la fermeture
            document.getElementById('scheduler-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function updateSchedulerPlaylistSelect() {
            const select = document.getElementById('scheduler-playlist-select');
            select.innerHTML = '<option value="">Choisir une playlist...</option>';

            Object.values(playlists).forEach(playlist => {
                const option = document.createElement('option');
                option.value = playlist.id;
                option.textContent = `${truncateText(playlist.name, 20)} (${playlist.items.length} contenus)`;
                option.title = `${playlist.name} (${playlist.items.length} contenus)`; // Afficher le nom complet au survol
                select.appendChild(option);
            });
        }

        function updateCurrentSchedule(screenId) {
            const container = document.getElementById('current-schedule-list');
            const screenSchedule = schedules[screenId] || [];

            if (screenSchedule.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucune plage horaire d√©finie</p>';
                return;
            }

            // Tri automatique par heure de d√©but (format 24h)
            screenSchedule.sort((a, b) => {
                return a.start.localeCompare(b.start);
            });

            container.innerHTML = '';
            screenSchedule.forEach((entry, index) => {
                const playlist = playlists[entry.playlist_id];
                const playlistNameFull = playlist ? playlist.name : 'Playlist supprim√©e';
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 8px 12px; margin-bottom: 6px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #667eea; font-size: 0.9em;';
                item.innerHTML = `
                    <div style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px;">
                        <strong style="color: #333; flex-shrink: 0;">${entry.start} - ${entry.end}</strong>
                        <span style="color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: help;" title="${playlistNameFull}">‚Ä¢ ${playlistNameFull}</span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                        <button class="btn btn-edit" onclick="editScheduleEntry('${screenId}', ${index})" style="width: auto; padding: 4px 12px; font-size: 0.85em;">‚úèÔ∏è √âditer</button>
                        <button class="btn btn-danger" onclick="removeScheduleEntry('${screenId}', ${index})" style="width: auto; padding: 4px 12px; font-size: 0.85em;">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function saveScheduleEntry() {
            const screenId = document.getElementById('scheduler-screen-id').value;
            const playlistId = document.getElementById('scheduler-playlist-select').value;
            const start = document.getElementById('scheduler-start').value;
            const end = document.getElementById('scheduler-end').value;

            if (!playlistId || !start || !end) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            // V√©rifier que l'heure de fin est apr√®s l'heure de d√©but
            if (start >= end) {
                alert('‚ùå Erreur : L\'heure de fin doit √™tre apr√®s l\'heure de d√©but');
                return;
            }

            if (!schedules[screenId]) {
                schedules[screenId] = [];
            }

            // V√©rifier s'il y a un chevauchement avec une plage horaire existante
            // (sauf avec l'entr√©e qu'on est en train d'√©diter)
            for (let i = 0; i < schedules[screenId].length; i++) {
                // Si on est en mode √©dition, ignorer l'entr√©e qu'on √©dite
                if (editingScheduleEntry && i === editingScheduleEntry.index) {
                    continue;
                }

                const entry = schedules[screenId][i];
                // Deux plages se chevauchent si :
                // - La nouvelle commence avant la fin de l'existante ET
                // - La nouvelle se termine apr√®s le d√©but de l'existante
                if (start < entry.end && end > entry.start) {
                    const existingPlaylist = playlists[entry.playlist_id];
                    const playlistName = existingPlaylist ? existingPlaylist.name : 'Playlist supprim√©e';
                    alert(`‚ùå Conflit de plage horaire !\n\nLa plage ${start} - ${end} chevauche une plage existante :\n${entry.start} - ${entry.end} : ${playlistName}\n\nVeuillez choisir une plage horaire diff√©rente.`);
                    return;
                }
            }

            // Si on est en mode √©dition, modifier l'entr√©e existante
            if (editingScheduleEntry) {
                schedules[screenId][editingScheduleEntry.index] = {
                    playlist_id: playlistId,
                    start: start,
                    end: end
                };
            } else {
                // Sinon, ajouter une nouvelle entr√©e
                schedules[screenId].push({
                    playlist_id: playlistId,
                    start: start,
                    end: end
                });
            }

            // Tri automatique par heure de d√©but (format 24h)
            schedules[screenId].sort((a, b) => {
                return a.start.localeCompare(b.start);
            });

            socket.emit('update_schedule', {
                screen_id: screenId,
                schedule: schedules[screenId]
            });

            // R√©initialiser le formulaire et le mode √©dition
            document.getElementById('scheduler-playlist-select').value = '';
            document.getElementById('scheduler-start').value = '';
            document.getElementById('scheduler-end').value = '';
            cancelScheduleEdit();

            updateCurrentSchedule(screenId);
        }

        function editScheduleEntry(screenId, index) {
            const entry = schedules[screenId][index];

            // Pr√©-remplir le formulaire
            document.getElementById('scheduler-playlist-select').value = entry.playlist_id;
            document.getElementById('scheduler-start').value = entry.start;
            document.getElementById('scheduler-end').value = entry.end;

            // Activer le mode √©dition
            editingScheduleEntry = { screenId, index };

            // Changer le titre et le bouton
            document.getElementById('scheduler-form-title').textContent = '‚úèÔ∏è Modifier la plage horaire';
            document.getElementById('scheduler-submit-btn').innerHTML = 'üíæ Enregistrer les modifications';
            document.getElementById('scheduler-cancel-edit-btn').style.display = 'block';

            // Scroll vers le formulaire
            document.getElementById('scheduler-form-title').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function cancelScheduleEdit() {
            // R√©initialiser le mode √©dition
            editingScheduleEntry = null;

            // Restaurer le titre et le bouton
            document.getElementById('scheduler-form-title').textContent = 'Ajouter une plage horaire';
            document.getElementById('scheduler-submit-btn').innerHTML = '+ Ajouter au Planning';
            document.getElementById('scheduler-cancel-edit-btn').style.display = 'none';

            // Vider les champs
            document.getElementById('scheduler-playlist-select').value = '';
            document.getElementById('scheduler-start').value = '';
            document.getElementById('scheduler-end').value = '';
        }

        function removeScheduleEntry(screenId, index) {
            schedules[screenId].splice(index, 1);
            socket.emit('update_schedule', {
                screen_id: screenId,
                schedule: schedules[screenId]
            });
            updateCurrentSchedule(screenId);
        }

        function openAddContentModal() {
            document.getElementById('content-modal-title').textContent = 'üé¨ Ajouter un Contenu';
            document.getElementById('content-id').value = '';
            document.getElementById('content-name').value = '';
            document.getElementById('content-type').value = 'url';
            document.getElementById('content-url').value = '';
            document.getElementById('content-duration').value = '00:00:10';
            document.getElementById('duration-error').style.display = 'none';
            document.getElementById('content-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function editContent(contentId) {
            const content = contentLibrary.find(c => c.id === contentId);
            if (!content) return;

            document.getElementById('content-modal-title').textContent = '‚úèÔ∏è √âditer le Contenu';
            document.getElementById('content-id').value = content.id;
            document.getElementById('content-name').value = content.name;
            document.getElementById('content-type').value = content.type;
            document.getElementById('content-url').value = content.url;
            // Si la dur√©e est 0, mettre une valeur par d√©faut
            const durationValue = content.duration > 0 ? secondsToTimeInput(content.duration) : '00:00:10';
            document.getElementById('content-duration').value = durationValue;
            document.getElementById('duration-error').style.display = 'none';
            document.getElementById('content-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeContentModal() {
            document.getElementById('content-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            // R√©initialiser les messages d'erreur/loading
            document.getElementById('youtube-loading').style.display = 'none';
            document.getElementById('youtube-error').style.display = 'none';
            document.getElementById('duration-error').style.display = 'none';
        }

        function validateDuration() {
            const durationInput = document.getElementById('content-duration').value;
            const errorDiv = document.getElementById('duration-error');
            const duration = hmsToSeconds(durationInput);

            if (duration <= 0) {
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        async function handleYoutubeUrl() {
            const url = document.getElementById('content-url').value;
            const type = document.getElementById('content-type').value;
            const loadingDiv = document.getElementById('youtube-loading');
            const errorDiv = document.getElementById('youtube-error');

            // Cacher les messages
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            // V√©rifier si c'est une URL YouTube et si le type est youtube
            if (type !== 'youtube' || !url) {
                return;
            }

            // Extraire l'ID de la vid√©o
            const videoIdMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);
            if (!videoIdMatch) {
                errorDiv.textContent = '‚ö†Ô∏è URL YouTube invalide';
                errorDiv.style.display = 'block';
                return;
            }

            const videoId = videoIdMatch[1];
            loadingDiv.style.display = 'block';

            try {
                const response = await fetch(`/api/youtube-metadata/${videoId}`);
                const data = await response.json();

                if (response.ok) {
                    // Mettre √† jour les champs
                    const nameField = document.getElementById('content-name');
                    const durationField = document.getElementById('content-duration');

                    // Ne remplacer le nom que s'il est vide
                    if (!nameField.value || nameField.value === '') {
                        nameField.value = data.title;
                    }

                    durationField.value = secondsToTimeInput(data.duration);
                    loadingDiv.style.display = 'none';

                    // Afficher un message de succ√®s temporaire
                    loadingDiv.textContent = '‚úÖ M√©tadonn√©es r√©cup√©r√©es avec succ√®s';
                    loadingDiv.style.color = '#28a745';
                    loadingDiv.style.display = 'block';
                    setTimeout(() => {
                        loadingDiv.style.display = 'none';
                        loadingDiv.textContent = 'üîÑ R√©cup√©ration des m√©tadonn√©es YouTube...';
                        loadingDiv.style.color = '#667eea';
                    }, 3000);
                } else {
                    errorDiv.textContent = `‚ö†Ô∏è ${data.error || 'Erreur lors de la r√©cup√©ration des m√©tadonn√©es'}`;
                    if (data.help) {
                        errorDiv.textContent += ` - ${data.help}`;
                    }
                    errorDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                }
            } catch (error) {
                errorDiv.textContent = '‚ö†Ô∏è Erreur de connexion au serveur';
                errorDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
            }
        }

        function saveContent() {
            const contentId = document.getElementById('content-id').value;
            const name = document.getElementById('content-name').value;
            const type = document.getElementById('content-type').value;
            const url = document.getElementById('content-url').value;
            const durationInput = document.getElementById('content-duration').value;
            const duration = hmsToSeconds(durationInput);

            if (!name || !url) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            if (duration <= 0) {
                alert('‚ùå Erreur : La dur√©e doit √™tre sup√©rieure √† 0.\n\nVeuillez d√©finir une dur√©e valide (ex: 00:00:10).');
                document.getElementById('duration-error').style.display = 'block';
                return;
            }

            const contentData = {
                id: contentId || 'content_' + Date.now(),
                name: name,
                type: type,
                url: url,
                duration: duration
            };

            if (contentId) {
                socket.emit('update_content', contentData);
            } else {
                socket.emit('add_content', contentData);
            }

            closeContentModal();
        }

        function deleteContent(contentId) {
            const content = contentLibrary.find(c => c.id === contentId);
            if (confirm(`Supprimer "${content.name}" ?`)) {
                socket.emit('delete_content', { content_id: contentId });
            }
        }

        // DEBUG MODAL

        let debugScreenId = null;
        let debugInterval = null;

        function openDebugModal(screenId) {
            debugScreenId = screenId;
            const screen = screens[screenId];

            if (!screen) return;

            const debugScreenNameElement = document.getElementById('debug-screen-name');
            debugScreenNameElement.textContent = truncateText(screen.name, 25);
            debugScreenNameElement.title = screen.name;
            document.getElementById('debug-modal').classList.add('active');
            document.body.classList.add('modal-open');

            // Rafra√Æchir imm√©diatement
            updateDebugInfo();

            // Rafra√Æchir toutes les 2 secondes
            debugInterval = setInterval(updateDebugInfo, 2000);
        }

        function closeDebugModal() {
            document.getElementById('debug-modal').classList.remove('active');
            document.body.classList.remove('modal-open');

            // Arr√™ter le rafra√Æchissement
            if (debugInterval) {
                clearInterval(debugInterval);
                debugInterval = null;
            }

            debugScreenId = null;
        }

        function updateDebugInfo() {
            if (!debugScreenId || !screens[debugScreenId]) return;

            const screen = screens[debugScreenId];
            const schedule = schedules[debugScreenId] || [];

            // √âtat actuel
            document.getElementById('debug-status').textContent = screen.status === 'online' ? 'üü¢ En ligne' : 'üî¥ Hors ligne';
            document.getElementById('debug-status').style.color = screen.status === 'online' ? '#28a745' : '#dc3545';

            // Utiliser les infos de debug pour avoir les vraies valeurs
            const debugInfo = screen.debug_info || {};
            const currentContentName = debugInfo.current_content_name || screen.current_content || 'Aucun';
            const debugCurrentContent = document.getElementById('debug-current-content');
            debugCurrentContent.textContent = currentContentName === 'Aucun' ? currentContentName : truncateText(currentContentName, 30);
            debugCurrentContent.title = currentContentName;

            // Playlist active
            const currentPlaylistName = debugInfo.current_playlist_name || screen.current_playlist || 'Aucune';
            const debugPlaylist = document.getElementById('debug-playlist');
            debugPlaylist.textContent = currentPlaylistName === 'Aucune' ? currentPlaylistName : truncateText(currentPlaylistName, 30);
            debugPlaylist.title = currentPlaylistName;
            document.getElementById('debug-playlist-index').textContent = debugInfo.playlist_index !== undefined
                ? `${debugInfo.playlist_index + 1}/${debugInfo.playlist_length || '?'}`
                : '--';

            // Temporisation
            if (debugInfo.elapsed_time !== undefined) {
                document.getElementById('debug-elapsed-time').textContent = secondsToHMS(Math.floor(debugInfo.elapsed_time));
            } else {
                document.getElementById('debug-elapsed-time').textContent = '--';
            }

            if (debugInfo.current_duration !== undefined) {
                document.getElementById('debug-total-duration').textContent = secondsToHMS(debugInfo.current_duration);
            } else {
                document.getElementById('debug-total-duration').textContent = '--';
            }

            document.getElementById('debug-last-seen').textContent = screen.last_seen || '--';

            // R√©seau
            const debugScreenIdElement = document.getElementById('debug-screen-id');
            debugScreenIdElement.textContent = truncateText(screen.id, 25);
            debugScreenIdElement.title = screen.id;

            const debugLocationElement = document.getElementById('debug-location');
            debugLocationElement.textContent = truncateText(screen.location, 25);
            debugLocationElement.title = screen.location;

            const debugSocketIdElement = document.getElementById('debug-socket-id');
            debugSocketIdElement.textContent = screen.sid ? screen.sid.substring(0, 12) + '...' : '--';
            debugSocketIdElement.title = screen.sid || '--';

            // Planning
            const scheduleContainer = document.getElementById('debug-schedule');
            if (schedule.length === 0) {
                scheduleContainer.innerHTML = '<div style="color: #999;">Aucun planning d√©fini</div>';
            } else {
                const now = new Date().toTimeString().slice(0, 5);
                let html = '';
                schedule.forEach(entry => {
                    const playlist = playlists[entry.playlist_id];
                    const isActive = entry.start <= now && now <= entry.end;
                    const playlistNameFull = playlist ? playlist.name : 'Playlist supprim√©e';
                    const playlistName = truncateText(playlistNameFull, 20);
                    html += `<div style="padding: 5px; ${isActive ? 'background: #d4edda; border-left: 3px solid #28a745;' : ''}" title="${playlistNameFull}">
                        ${entry.start} - ${entry.end}: ${playlistName}
                        ${isActive ? ' <strong style="color: #28a745;">‚óè ACTIF</strong>' : ''}
                    </div>`;
                });
                scheduleContainer.innerHTML = html;
            }
        }

        // PARAM√àTRES

        function openSettingsModal() {
            // Charger la cl√© API actuelle
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('settings-youtube-api-key').value = data.youtube_api_key || '';
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des param√®tres:', error);
                });

            document.getElementById('settings-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            document.getElementById('settings-api-status').style.display = 'none';
        }

        function saveSettings() {
            const apiKey = document.getElementById('settings-youtube-api-key').value;
            const statusDiv = document.getElementById('settings-api-status');
            const statusText = document.getElementById('settings-api-status-text');

            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    youtube_api_key: apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusText.textContent = '‚úÖ Param√®tres sauvegard√©s avec succ√®s !';
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusText.textContent = '‚ùå Erreur lors de la sauvegarde';
                }
                statusDiv.style.display = 'block';

                // Masquer le message apr√®s 3 secondes
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Erreur:', error);
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusText.textContent = '‚ùå Erreur de connexion au serveur';
                statusDiv.style.display = 'block';
            });
        }

        // MISE √Ä JOUR SYST√àME

        let updateInfo = null;

        function openUpdateModal() {
            document.getElementById('update-modal').classList.add('active');
            document.body.classList.add('modal-open');
            // V√©rifier automatiquement les mises √† jour √† l'ouverture
            checkForUpdates();
        }

        function closeUpdateModal() {
            document.getElementById('update-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function checkForUpdates() {
            const checkBtn = document.getElementById('update-check-btn');
            const applyBtn = document.getElementById('update-apply-btn');
            const errorContainer = document.getElementById('update-error-container');
            const errorMessage = document.getElementById('update-error-message');
            const remoteInfo = document.getElementById('update-remote-info');
            const uptodateInfo = document.getElementById('update-uptodate-info');

            // D√©sactiver le bouton et afficher un √©tat de chargement
            checkBtn.disabled = true;
            checkBtn.textContent = 'üîÑ V√©rification en cours...';
            applyBtn.style.display = 'none';
            errorContainer.style.display = 'none';
            remoteInfo.style.display = 'none';
            uptodateInfo.style.display = 'none';

            fetch('/api/check-update')
                .then(response => response.json())
                .then(data => {
                    updateInfo = data;

                    // Afficher le commit actuel
                    document.getElementById('update-current-commit').textContent = data.current_commit || '--';

                    if (data.error) {
                        errorMessage.textContent = data.error;
                        errorContainer.style.display = 'block';
                    } else if (data.available) {
                        // Une mise √† jour est disponible
                        document.getElementById('update-remote-commit').textContent = data.remote_commit || '--';
                        document.getElementById('update-commits-behind').textContent = data.commits_behind || '?';
                        document.getElementById('update-latest-message').textContent = data.latest_message || 'Pas de message';
                        remoteInfo.style.display = 'block';
                        applyBtn.style.display = 'block';

                        // Afficher le badge de mise √† jour dans le header
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'flex';
                    } else {
                        // √Ä jour
                        uptodateInfo.style.display = 'block';
                        // Cacher le badge de mise √† jour
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'none';
                    }

                    checkBtn.disabled = false;
                    checkBtn.textContent = 'üîç V√©rifier les mises √† jour';
                })
                .catch(error => {
                    console.error('Erreur lors de la v√©rification des mises √† jour:', error);
                    errorMessage.textContent = 'Erreur de connexion au serveur';
                    errorContainer.style.display = 'block';
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'üîç V√©rifier les mises √† jour';
                });
        }

        function applyUpdate() {
            if (!updateInfo || !updateInfo.available) {
                alert('Aucune mise √† jour disponible');
                return;
            }

            if (!confirm(`Voulez-vous installer la mise √† jour ?\n\nCela va t√©l√©charger ${updateInfo.commits_behind} commit(s) depuis le d√©p√¥t distant.\n\n‚ö†Ô∏è Il est recommand√© de red√©marrer le serveur apr√®s la mise √† jour.`)) {
                return;
            }

            const applyBtn = document.getElementById('update-apply-btn');
            const checkBtn = document.getElementById('update-check-btn');
            const statusContainer = document.getElementById('update-status-container');
            const statusText = document.getElementById('update-status-text');
            const errorContainer = document.getElementById('update-error-container');
            const errorMessage = document.getElementById('update-error-message');

            // D√©sactiver les boutons et afficher un √©tat de chargement
            applyBtn.disabled = true;
            applyBtn.textContent = '‚¨áÔ∏è Installation en cours...';
            checkBtn.disabled = true;
            errorContainer.style.display = 'none';
            statusContainer.style.display = 'none';

            fetch('/api/apply-update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusContainer.style.background = '#d4edda';
                        statusContainer.style.color = '#155724';
                        statusText.innerHTML = `
                            ‚úÖ Mise √† jour install√©e avec succ√®s !<br>
                            <div style="margin-top: 10px; font-size: 0.9em;">
                                <strong>Nouveau commit:</strong> <code>${data.new_commit}</code><br>
                                ${data.requires_restart ? '<strong style="color: #dc3545;">‚ö†Ô∏è Red√©marrage du serveur recommand√©</strong>' : ''}
                            </div>
                        `;
                        statusContainer.style.display = 'block';

                        // Cacher le badge de mise √† jour
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'none';

                        // Mettre √† jour l'affichage
                        document.getElementById('update-current-commit').textContent = data.new_commit;
                        document.getElementById('update-remote-info').style.display = 'none';
                        document.getElementById('update-uptodate-info').style.display = 'block';
                        applyBtn.style.display = 'none';

                        // Proposer de red√©marrer le service
                        if (confirm(`üîÑ Voulez-vous red√©marrer le service digital-signage maintenant ?`)) {
                            restartService();
                        }
                    } else {
                        errorMessage.textContent = data.error || 'Erreur inconnue lors de l\'installation';
                        errorContainer.style.display = 'block';
                    }

                    applyBtn.disabled = false;
                    applyBtn.textContent = '‚¨áÔ∏è Installer la mise √† jour';
                    checkBtn.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur lors de l\'application de la mise √† jour:', error);
                    errorMessage.textContent = 'Erreur de connexion au serveur';
                    errorContainer.style.display = 'block';
                    applyBtn.disabled = false;
                    applyBtn.textContent = '‚¨áÔ∏è Installer la mise √† jour';
                    checkBtn.disabled = false;
                });
        }

        // V√©rification automatique au chargement de la page
        function checkForUpdatesOnLoad() {
            fetch('/api/check-update')
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        // Afficher le badge de mise √† jour
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'flex';
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la v√©rification automatique des mises √† jour:', error);
                });
            setTimeout(checkForUpdatesOnLoad, 60000); // V√©rifier toutes les minutes
        }

        // Auto-update
        socket.emit('get_state');

        // V√©rifier les mises √† jour au chargement de la page
        checkForUpdatesOnLoad();
    </script>
</body>
</html>