<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS MCO</title>
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <header style="position: relative;">
            <h1>ğŸ–¥ï¸ Gestionnaire d'Affichage Multi-Ã‰crans</h1>
            <p class="subtitle">ContrÃ´lez tous vos Ã©crans depuis une seule interface</p>
            <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; align-items: flex-end; flex-direction: column;">
                <button id="update-badge" onclick="openUpdateModal()" style="display: none; background: #28a745; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); gap: 8px; align-items: center;" title="Mise Ã  jour disponible">
                    ğŸ”„ Mise Ã  jour disponible
                </button>
                <button onclick="openSettingsModal()" style="background: #667eea; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;" title="ParamÃ¨tres">
                    âš™ï¸ ParamÃ¨tres
                </button>
            </div>
            <div style="position: absolute; top: 20px; left: 20px; display: flex; gap: 10px; align-items: flex-start; flex-direction: column; width: 220px;">
                <div>
                    <button onclick="togglePowerMenu(event)" class="power-menu-btn" title="Alimentation">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                    <div id="power-menu" class="power-menu">
                        <div class="power-menu-item" onclick="restartServiceFromMenu()">
                            <i class="fa-solid fa-rotate-right" style="color:rgb(21, 126, 212)"></i> RedÃ©marrer
                        </div>
                        <div class="power-menu-item" onclick="stopServiceFromMenu()">
                            <i class="fa-solid fa-stop" style="color:red; padding: 0 2px;"></i> ArrÃªter
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Modal Gestion Globale Playlists -->
        <div id="global-playlist-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“‹ Gestion des Playlists</h2>
                    <button class="close-modal" onclick="closeGlobalPlaylistModal()">&times;</button>
                </div>
                <div class="content-form">
                    <button class="btn" onclick="openCreatePlaylistModal()" style="margin-bottom: 20px;">+ CrÃ©er une Playlist</button>
                    
                    <div id="playlists-list" class="content-list"></div>
                </div>
            </div>
        </div>

        <!-- Modal CrÃ©er/Ã‰diter Playlist -->
        <div id="edit-playlist-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="edit-playlist-title">ğŸ“‹ CrÃ©er une Playlist</h2>
                    <button class="close-modal" onclick="closeEditPlaylistModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="edit-playlist-id">
                    <div class="form-group">
                        <label>Nom de la playlist</label>
                        <input type="text" id="edit-playlist-name" placeholder="Ex: Playlist Accueil">
                    </div>
                    <div class="form-group">
                        <label>Ajouter des contenus</label>
                        <select id="edit-playlist-content-select" onchange="updateSelectedContentInfo()">
                            <option value="">Choisir un contenu...</option>
                        </select>
                        <div id="selected-content-info" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                            <div style="font-size: 0.9em; color: #333;">
                                <strong>DurÃ©e:</strong> <span id="selected-content-duration">--</span>
                            </div>
                        </div>
                        <button class="btn" onclick="addToEditPlaylist()" style="margin-top: 10px; width: 100%;">+ Ajouter Ã  la playlist</button>
                    </div>
                    <div class="form-group">
                        <label>Contenus de la playlist</label>
                        <div id="edit-playlist-items" class="playlist-preview">
                            <p style="text-align: center; color: #999;">Aucun contenu ajoutÃ©</p>
                        </div>
                    </div>
                    <button class="btn btn-playlist" onclick="saveEditedPlaylist()">ğŸ’¾ Sauvegarder la Playlist</button>
                </div>
            </div>
        </div>

        <!-- Modal Ajouter/Ã‰diter Contenu -->
        <div id="content-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="content-modal-title">ğŸ¬ Ajouter un Contenu</h2>
                    <button class="close-modal" onclick="closeContentModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="content-id">
                    <div class="form-group">
                        <label>Nom du contenu</label>
                        <input type="text" id="content-name" placeholder="Ex: Page d'accueil">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="content-type" onchange="toggleImageUpload()">
                            <option value="url">Page Web (URL)</option>
                            <option value="video">VidÃ©o (URL)</option>
                            <option value="image">Image (URL ou Upload)</option>
                            <option value="youtube">YouTube</option>
                        </select>
                    </div>
                    <div class="form-group" id="url-group">
                        <label>URL / Lien</label>
                        <input type="text" id="content-url" placeholder="https://..." onblur="handleYoutubeUrl()">
                        <div id="youtube-loading" style="display: none; color: #667eea; margin-top: 8px; font-size: 0.9em;">
                            ğŸ”„ RÃ©cupÃ©ration des mÃ©tadonnÃ©es YouTube...
                        </div>
                        <div id="youtube-error" style="display: none; color: #dc3545; margin-top: 8px; font-size: 0.9em;"></div>
                    </div>
                    <div class="form-group" id="image-upload-group" style="display: none;">
                        <label>ğŸ“ Upload d'image</label>
                        <input type="file" id="image-file" accept="image/*" onchange="handleImageUpload()">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            Formats acceptÃ©s: PNG, JPG, JPEG, GIF, BMP, WEBP, SVG (max 50 MB)
                        </p>
                        <div id="upload-status" style="margin-top: 8px; font-size: 0.9em;"></div>
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;" id="image-or-separator">
                            <strong>OU</strong> entrez une URL ci-dessus
                        </div>
                    </div>
                    <div class="form-group">
                        <label>DurÃ©e d'affichage (obligatoire)</label>
                        <input type="text" id="content-duration" value="00:00:10" placeholder="HH:MM:SS ou 1h 30m 45s" oninput="validateDuration()">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            Formats acceptÃ©s: <code>01:30:45</code>, <code>1h 30m 45s</code>, <code>90</code> (secondes)
                        </p>
                        <div id="duration-error" style="display: none; color: #dc3545; margin-top: 8px; font-size: 0.9em; font-weight: bold;">
                            âš ï¸ La durÃ©e doit Ãªtre supÃ©rieure Ã  0. Une durÃ©e infinie n'est pas permise pour les contenus.
                        </div>
                    </div>
                    <button class="btn" onclick="saveContent()">ğŸ’¾ Sauvegarder</button>
                </div>
            </div>
        </div>

        <!-- Modal Configuration Ã‰cran -->
        <div id="screen-config-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âš™ï¸ Configuration de l'Ã‰cran</h2>
                    <button class="close-modal" onclick="closeScreenConfigModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="config-screen-id">

                    <h3 style="color: #667eea; margin-bottom: 15px;">Contenu par dÃ©faut</h3>
                    <div class="form-group">
                        <label>Contenu Ã  afficher quand rien n'est planifiÃ©</label>
                        <select id="config-default-content">
                            <option value="">Aucun (Ã©cran vide)</option>
                        </select>
                    </div>

                    <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 30px;">Comportement entre les plages horaires</h3>
                    <div class="form-group">
                        <label>Que faire entre les plages horaires planifiÃ©es ?</label>
                        <select id="config-idle-behavior">
                            <option value="show_default">Afficher le contenu par dÃ©faut</option>
                            <option value="continue_last">Continuer la derniÃ¨re playlist</option>
                        </select>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            â€¢ <strong>Afficher le contenu par dÃ©faut</strong> : Retourne au contenu par dÃ©faut dÃ¨s qu'une plage horaire se termine<br>
                            â€¢ <strong>Continuer la derniÃ¨re playlist</strong> : La playlist reste en boucle jusqu'Ã  la prochaine plage horaire
                        </p>
                    </div>

                    <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 30px;">Options d'affichage</h3>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="config-show-clock" style="width: 20px; height: 20px; cursor: pointer;">
                            <span>ğŸ• Afficher l'heure en bas Ã  droite</span>
                        </label>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            Affiche l'heure actuelle en temps rÃ©el dans le coin infÃ©rieur droit de l'Ã©cran
                        </p>
                    </div>

                    <button class="btn" onclick="saveScreenConfig()">ğŸ’¾ Sauvegarder la Configuration</button>
                </div>
            </div>
        </div>

        <!-- Modal Debug Ã‰cran -->
        <div id="debug-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ› Debug - <span id="debug-screen-name">Ã‰cran</span></h2>
                    <button class="close-modal" onclick="closeDebugModal()">&times;</button>
                </div>
                <div class="content-form">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">ğŸ“Š Ã‰tat actuel</strong>
                            <div style="margin-top: 8px; line-height: 1.8;">
                                <div>ğŸ”Œ Statut: <span id="debug-status" style="font-weight: bold;">--</span></div>
                                <div>ğŸ“º Contenu actuel: <span id="debug-current-content">--</span></div>
                                <div>ğŸ“‹ Playlist active: <span id="debug-playlist">--</span></div>
                                <div>â±ï¸ Index playlist: <span id="debug-playlist-index">--</span></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">â° Temporisation</strong>
                            <div style="margin-top: 8px; line-height: 1.8;">
                                <div>â²ï¸ Temps Ã©coulÃ©: <span id="debug-elapsed-time">--</span></div>
                                <div>â³ DurÃ©e totale: <span id="debug-total-duration">--</span></div>
                                <div>ğŸ“… DerniÃ¨re activitÃ©: <span id="debug-last-seen">--</span></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">ğŸŒ RÃ©seau</strong>
                            <div style="margin-top: 8px; line-height: 1.8;">
                                <div>ğŸ†” ID Ã‰cran: <span id="debug-screen-id">--</span></div>
                                <div><i class="fa-solid fa-location-dot" style="color:red; padding: 0 4px;"></i> Emplacement: <span id="debug-location">--</span></div>
                                <div>ğŸ”— Socket ID: <span id="debug-socket-id">--</span></div>
                            </div>
                        </div>

                        <div>
                            <strong style="color: #667eea;">ğŸ“… Planning actif</strong>
                            <div id="debug-schedule" style="margin-top: 8px; line-height: 1.8;">
                                --
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; color: #999; font-size: 0.85em;">
                        â„¹ï¸ Les donnÃ©es se rafraÃ®chissent automatiquement toutes les 2 secondes
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Planificateur -->
        <div id="scheduler-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“… Planifier l'Ã‰cran</h2>
                    <button class="close-modal" onclick="closeSchedulerModal()">&times;</button>
                </div>
                <div class="content-form">
                    <input type="hidden" id="scheduler-screen-id">

                    <h3 style="color: #667eea; margin-bottom: 15px;">Planning actuel</h3>
                    <div id="current-schedule-list" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background: #fafafa;"></div>

                    <h3 id="scheduler-form-title" style="color: #667eea; margin-bottom: 15px;">Ajouter une plage horaire</h3>
                    <div class="form-group">
                        <label>Playlist Ã  afficher</label>
                        <select id="scheduler-playlist-select"></select>
                    </div>
                    <div class="form-group">
                        <label>Heure de dÃ©but</label>
                        <input type="time" id="scheduler-start">
                    </div>
                    <div class="form-group">
                        <label>Heure de fin</label>
                        <input type="time" id="scheduler-end">
                    </div>
                    <button id="scheduler-submit-btn" class="btn" onclick="saveScheduleEntry()">+ Ajouter au Planning</button>
                    <button id="scheduler-cancel-edit-btn" class="btn" onclick="cancelScheduleEdit()" style="display: none; margin-top: 10px; background: #6c757d;">âœ–ï¸ Annuler la modification</button>
                </div>
            </div>
        </div>

        <!-- Modal ParamÃ¨tres -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âš™ï¸ ParamÃ¨tres</h2>
                    <button class="close-modal" onclick="closeSettingsModal()">&times;</button>
                </div>
                <div class="content-form">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Configuration YouTube API</h3>
                    <div class="form-group">
                        <label>ClÃ© API YouTube</label>
                        <input type="text" id="settings-youtube-api-key" placeholder="Entrez votre clÃ© API YouTube">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            Cette clÃ© permet de rÃ©cupÃ©rer automatiquement les mÃ©tadonnÃ©es (titre, durÃ©e) des vidÃ©os YouTube.<br>
                            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #667eea;">Obtenir une clÃ© API YouTube</a>
                        </p>
                    </div>

                    <div id="settings-api-status" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;">
                        <strong id="settings-api-status-text"></strong>
                    </div>

                    <button class="btn" onclick="saveSettings()">ğŸ’¾ Sauvegarder</button>
                </div>
            </div>
        </div>

        <!-- Modal Mise Ã  jour -->
        <div id="update-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ”„ Mise Ã  jour systÃ¨me</h2>
                    <button class="close-modal" onclick="closeUpdateModal()">&times;</button>
                </div>
                <div class="content-form">
                    <div id="update-info-container" style="margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #667eea;">ğŸ“Š Ã‰tat actuel</strong>
                            </div>
                            <div style="line-height: 1.8;">
                                <div>ğŸ“ Commit actuel: <code id="update-current-commit">--</code></div>
                                <div id="update-remote-info" style="display: none;">
                                    <div>ğŸŒ Commit distant: <code id="update-remote-commit">--</code></div>
                                    <div>ğŸ“¦ Commits en retard: <strong id="update-commits-behind" style="color: #dc3545;">--</strong></div>
                                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #667eea;">
                                        <strong>Dernier commit:</strong><br>
                                        <span id="update-latest-message" style="font-style: italic; color: #666;">--</span>
                                    </div>
                                </div>
                                <div id="update-uptodate-info" style="display: none; color: #28a745; font-weight: bold; margin-top: 10px;">
                                    âœ… Vous Ãªtes Ã  jour !
                                </div>
                            </div>
                        </div>

                        <div id="update-error-container" style="display: none; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>âš ï¸ Erreur:</strong>
                            <div id="update-error-message" style="margin-top: 8px;"></div>
                        </div>

                        <div id="update-status-container" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong id="update-status-text"></strong>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="checkForUpdates()" id="update-check-btn">ğŸ” VÃ©rifier les mises Ã  jour</button>
                        <button class="btn" onclick="applyUpdate()" id="update-apply-btn" style="display: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">â¬‡ï¸ Installer la mise Ã  jour</button>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 3px solid #ffc107;">
                        <strong style="color: #856404;">â„¹ï¸ Note importante:</strong>
                        <div style="font-size: 0.9em; color: #856404; margin-top: 5px;">
                            AprÃ¨s une mise Ã  jour, il est recommandÃ© de redÃ©marrer le serveur pour appliquer tous les changements.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reste du HTML identique... -->
        <div class="main-content">
            <div class="section" style="grid-column: 1 / -1;">
                <div class="section-header">
                    <h2>ğŸ“º Ã‰crans ConnectÃ©s</h2>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-screens">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="online-screens">0</div>
                        <div class="stat-label">En ligne</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="content-count">0</div>
                        <div class="stat-label">Contenus</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="playlist-count">0</div>
                        <div class="stat-label">Playlists</div>
                    </div>
                </div>
                <div class="screen-grid" id="screens-container"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ Playlists</h2>
                    <button class="btn btn-header" onclick="openCreatePlaylistModal()">+ Ajouter</button>
                </div>
                <div id="playlists-summary" class="content-list"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“š BibliothÃ¨que</h2>
                    <button class="btn btn-header" onclick="openAddContentModal()">+ Ajouter</button>
                </div>
                <div class="content-list" id="content-library"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let screens = {};
        let contentLibrary = [];
        let playlists = {};
        let schedules = {};
        let editingPlaylist = [];
        let editingScheduleEntry = null; // {screenId, index} quand on Ã©dite une entrÃ©e

        // Fonctions de conversion de durÃ©e
        function secondsToHMS(seconds) {
            if (seconds === 0) return 'âˆ (infini)';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;

            const parts = [];
            if (h > 0) parts.push(`${h}h`);
            if (m > 0) parts.push(`${m}m`);
            if (s > 0 || parts.length === 0) parts.push(`${s}s`);

            return parts.join(' ');
        }

        function hmsToSeconds(hms) {
            if (!hms || hms === '' || hms === '0') return 0;

            // Format acceptÃ©s: "1:30:45", "90:45", "45", "1h 30m 45s", "1h30m45s"
            let totalSeconds = 0;

            // Si c'est dÃ©jÃ  un nombre simple
            if (/^\d+$/.test(hms)) {
                return parseInt(hms);
            }

            // Format avec h, m, s
            const hMatch = hms.match(/(\d+)h/);
            const mMatch = hms.match(/(\d+)m/);
            const sMatch = hms.match(/(\d+)s/);

            if (hMatch || mMatch || sMatch) {
                if (hMatch) totalSeconds += parseInt(hMatch[1]) * 3600;
                if (mMatch) totalSeconds += parseInt(mMatch[1]) * 60;
                if (sMatch) totalSeconds += parseInt(sMatch[1]);
                return totalSeconds;
            }

            // Format HH:MM:SS ou MM:SS ou SS
            const parts = hms.split(':').map(p => parseInt(p) || 0);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 1) {
                return parts[0];
            }

            return 0;
        }

        function getContentTypeIcon(type) {
            const icons = {
                'url': '<i class="fas fa-globe"></i>',
                'video': '<i class="fas fa-video"></i>',
                'image': '<i class="fas fa-image"></i>',
                'youtube': '<i class="fab fa-youtube"></i>'
            };
            return icons[type] || '<i class="fas fa-file"></i>';
        }

        function getContentTypeText(type) {
            const types = {
                'url': 'Url',
                'video': 'VidÃ©o',
                'image': 'Image',
                'youtube': 'YouTube'
            };
            return types[type] || type;
        }

        function truncateText(text, maxLength = 25) {
            if (!text) return text;
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function secondsToTimeInput(seconds) {
            if (seconds === 0) return '00:00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function timeInputToSeconds(timeStr) {
            if (!timeStr || timeStr === '00:00:00') return 0;
            const parts = timeStr.split(':').map(p => parseInt(p) || 0);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        socket.on('connect', () => {
            console.log('ConnectÃ© au serveur');
            socket.emit('get_state');
        });

        socket.on('state_update', (data) => {
            screens = data.screens;
            contentLibrary = data.content;
            playlists = data.playlists || {};
            schedules = data.schedules || {};
            updateUI();
        });

        function updateUI() {
            updateStats();
            updateScreens();
            updateContentLibrary();
            updatePlaylistsSummary();
        }

        function updateStats() {
            const total = Object.keys(screens).length;
            const online = Object.values(screens).filter(s => s.status === 'online').length;
            document.getElementById('total-screens').textContent = total;
            document.getElementById('online-screens').textContent = online;
            document.getElementById('content-count').textContent = contentLibrary.length;
            document.getElementById('playlist-count').textContent = Object.keys(playlists).length;
        }

        function updateScreens() {
            const container = document.getElementById('screens-container');

            // Sauvegarder quel menu est ouvert avant de tout recrÃ©er
            let openMenuId = null;
            const openMenu = document.querySelector('.screen-context-menu.active');
            if (openMenu) {
                openMenuId = openMenu.id.replace('screen-menu-', '');
            }

            container.innerHTML = '';

            for (const [id, screen] of Object.entries(screens)) {
                const card = document.createElement('div');
                card.className = `screen-card ${screen.status}`;
                card.innerHTML = `
                    <div style="position: relative;">
                        <div class="screen-name" title="${screen.name}">${truncateText(screen.name, 20)}</div>
                        <button onclick="toggleScreenMenu(event, '${id}')" class="screen-menu-btn" title="Options">
                            â‹®
                        </button>
                        <div id="screen-menu-${id}" class="screen-context-menu">
                            <div class="menu-item" onclick="refreshScreen('${id}')">
                                ğŸ”„ RafraÃ®chir
                            </div>
                            <div class="menu-item" onclick="closeScreenMenu('${id}'); openDebugModal('${id}')">
                                ğŸ› Debug
                            </div>
                            <div class="menu-item" onclick="closeScreenMenu('${id}'); openScreenConfig('${id}')">
                                âš™ï¸ Configurer
                            </div>
                            <div class="menu-item" onclick="closeScreenMenu('${id}'); openScheduler('${id}')">
                                ğŸ“… Planning
                            </div>
                        </div>
                    </div>
                    <span class="screen-status status-${screen.status}">
                        ${screen.status === 'online' ? 'ğŸŸ¢ En ligne' : 'ğŸ”´ Hors ligne'}
                    </span>
                    <div class="screen-info" title="${screen.location}"><i class="fa-solid fa-location-dot" style="color:red; padding: 0 4px;"></i> Emplacement: ${truncateText(screen.location, 20)}</div>
                    <div class="screen-info" title="${screen.current_playlist || 'Aucune en cours'}">ğŸ“‹ Playlist: ${truncateText(screen.current_playlist || 'Aucune en cours', 15)}</div>
                    <div class="screen-info" title="${screen.current_content || 'Aucun en cours'}">ğŸ¬ Contenu: ${truncateText(screen.current_content || 'Aucun en cours', 15)}</div>
                `;
                container.appendChild(card);
            }

            // Restaurer le menu ouvert si il y en avait un
            if (openMenuId) {
                const menuToReopen = document.getElementById(`screen-menu-${openMenuId}`);
                if (menuToReopen) {
                    menuToReopen.classList.add('active');
                }
            }
        }

        function updateContentLibrary() {
            const container = document.getElementById('content-library');
            container.innerHTML = '';

            if (contentLibrary.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Aucun contenu</p>';
                return;
            }

            contentLibrary.forEach(content => {
                const item = document.createElement('div');
                item.className = 'content-item';
                const truncatedUrl = content.url.length > 25 ? content.url.substring(0, 25) + '...' : content.url;
                item.innerHTML = `
                    <div style="flex: 1;">
                        <strong title="${content.name}">${content.name}</strong>
                        <span class="content-type">${getContentTypeText(content.type)}</span>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            <span title="${content.url}">ğŸ”— ${truncatedUrl}</span> | â±ï¸ ${secondsToHMS(content.duration)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-edit" onclick="editContent('${content.id}')">âœï¸ Ã‰diter</button>
                        <button class="btn btn-danger" onclick="deleteContent('${content.id}')" style="width: auto; padding: 8px 20px;">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updatePlaylistsSummary() {
            const container = document.getElementById('playlists-summary');
            container.innerHTML = '';

            const playlistsArray = Object.values(playlists);
            if (playlistsArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Aucune playlist crÃ©Ã©e</p>';
                return;
            }

            playlistsArray.forEach(playlist => {
                const item = document.createElement('div');
                item.className = 'content-item';

                let totalDuration = playlist.items.reduce((sum, item) => sum + item.duration, 0);
                const truncatedName = truncateText(playlist.name, 20);

                item.innerHTML = `
                    <div style="flex: 1;">
                        <strong title="${playlist.name}">${truncatedName}</strong>
                        <span class="content-type">${playlist.items.length} contenus</span>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            â±ï¸ ${secondsToHMS(totalDuration)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-edit" onclick="editPlaylist('${playlist.id}')">âœï¸ Ã‰diter</button>
                        <button class="btn btn-danger" onclick="deletePlaylist('${playlist.id}')" style="width: auto; padding: 8px 20px;">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // GESTION DES PLAYLISTS

        function openCreatePlaylistModal() {
            document.getElementById('edit-playlist-title').textContent = 'ğŸ“‹ CrÃ©er une Playlist';
            document.getElementById('edit-playlist-id').value = '';
            document.getElementById('edit-playlist-name').value = '';
            editingPlaylist = [];
            updateEditPlaylistPreview();
            updateEditPlaylistContentSelect();
            document.getElementById('edit-playlist-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function editPlaylist(playlistId) {
            const playlist = playlists[playlistId];
            document.getElementById('edit-playlist-title').textContent = 'âœï¸ Ã‰diter la Playlist';
            document.getElementById('edit-playlist-id').value = playlistId;
            document.getElementById('edit-playlist-name').value = playlist.name;
            editingPlaylist = [...playlist.items];
            updateEditPlaylistPreview();
            updateEditPlaylistContentSelect();
            document.getElementById('edit-playlist-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeEditPlaylistModal() {
            document.getElementById('edit-playlist-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function updateEditPlaylistContentSelect() {
            const select = document.getElementById('edit-playlist-content-select');
            select.innerHTML = '<option value="">Choisir un contenu...</option>';
            contentLibrary.forEach(content => {
                const option = document.createElement('option');
                option.value = content.id;
                option.textContent = `${truncateText(content.name, 30)} (${getContentTypeText(content.type)})`;
                select.appendChild(option);
            });
            // RÃ©initialiser l'affichage des infos
            document.getElementById('selected-content-info').style.display = 'none';
        }

        function updateSelectedContentInfo() {
            const contentId = document.getElementById('edit-playlist-content-select').value;
            const infoDiv = document.getElementById('selected-content-info');
            const durationSpan = document.getElementById('selected-content-duration');

            if (!contentId) {
                infoDiv.style.display = 'none';
                return;
            }

            const content = contentLibrary.find(c => c.id === contentId);
            if (!content) return;

            durationSpan.textContent = secondsToHMS(content.duration);
            infoDiv.style.display = 'block';
        }

        function addToEditPlaylist() {
            const contentId = document.getElementById('edit-playlist-content-select').value;

            if (!contentId) {
                alert('Veuillez sÃ©lectionner un contenu');
                return;
            }

            const content = contentLibrary.find(c => c.id === contentId);
            if (!content) return;

            // Utiliser la durÃ©e du contenu
            const duration = content.duration;

            if (duration <= 0) {
                alert('Ce contenu a une durÃ©e infinie (0). Veuillez dÃ©finir une durÃ©e dans la bibliothÃ¨que avant de l\'ajouter Ã  une playlist.');
                return;
            }

            editingPlaylist.push({
                content: content,
                duration: duration
            });

            updateEditPlaylistPreview();
            document.getElementById('edit-playlist-content-select').value = '';
            // Cacher l'info du contenu sÃ©lectionnÃ©
            document.getElementById('selected-content-info').style.display = 'none';
        }

        function removeFromEditPlaylist(index) {
            editingPlaylist.splice(index, 1);
            updateEditPlaylistPreview();
        }

        function updateEditPlaylistPreview() {
            const container = document.getElementById('edit-playlist-items');

            if (editingPlaylist.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Aucun contenu ajoutÃ©</p>';
                return;
            }

            let totalDuration = 0;
            container.innerHTML = '';

            editingPlaylist.forEach((item, index) => {
                totalDuration += item.duration;
                const div = document.createElement('div');
                div.className = 'playlist-item';
                div.style.cssText = 'background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea;';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <strong title="${item.content.name}">${index + 1}. ${item.content.name}</strong>
                        <span class="content-type">${getContentTypeText(item.content.type)}</span>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            â±ï¸ ${secondsToHMS(item.duration)}
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeFromEditPlaylist(${index})" style="width: auto; padding: 8px 20px;">ğŸ—‘ï¸</button>
                `;
                container.appendChild(div);
            });

            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 15px; padding: 10px; background: #667eea; color: white; border-radius: 8px; text-align: center; font-weight: bold;';
            summary.innerHTML = `ğŸ“Š ${editingPlaylist.length} contenu(s) | DurÃ©e totale: ${secondsToHMS(totalDuration)}`;
            container.appendChild(summary);
        }

        function saveEditedPlaylist() {
            const playlistId = document.getElementById('edit-playlist-id').value;
            const playlistName = document.getElementById('edit-playlist-name').value;

            if (!playlistName) {
                alert('Veuillez donner un nom Ã  la playlist');
                return;
            }

            if (editingPlaylist.length === 0) {
                alert('Veuillez ajouter au moins un contenu');
                return;
            }

            if (playlistId) {
                // Modification
                socket.emit('update_playlist', {
                    id: playlistId,
                    name: playlistName,
                    items: editingPlaylist
                });
            } else {
                // CrÃ©ation
                socket.emit('create_playlist', {
                    name: playlistName,
                    items: editingPlaylist
                });
            }

            closeEditPlaylistModal();
        }

        function deletePlaylist(playlistId) {
            const playlist = playlists[playlistId];
            if (confirm(`Supprimer la playlist "${playlist.name}" ?`)) {
                socket.emit('delete_playlist', { playlist_id: playlistId });
            }
        }

        // MENU CONTEXTUEL Ã‰CRAN

        function toggleScreenMenu(event, screenId) {
            event.stopPropagation();

            // Fermer tous les autres menus
            document.querySelectorAll('.screen-context-menu').forEach(menu => {
                if (menu.id !== `screen-menu-${screenId}`) {
                    menu.classList.remove('active');
                }
            });

            // Toggle le menu actuel
            const menu = document.getElementById(`screen-menu-${screenId}`);
            menu.classList.toggle('active');
        }

        function closeScreenMenu(screenId) {
            const menu = document.getElementById(`screen-menu-${screenId}`);
            if (menu) {
                menu.classList.remove('active');
            }
        }

        function refreshScreen(screenId) {
            const screen = screens[screenId];
            if (screen && screen.status === 'online') {
                if (confirm(`RafraÃ®chir l'Ã©cran "${screen.name}" ?\n\nCela rechargera la page sur l'Ã©cran distant.`)) {
                    socket.emit('reload_screen', { screen_id: screenId });
                }
            } else {
                alert('L\'Ã©cran doit Ãªtre en ligne pour Ãªtre rafraÃ®chi.');
            }

            // Fermer le menu
            document.getElementById(`screen-menu-${screenId}`).classList.remove('active');
        }

        function restartService() {

            fetch('/restart-service', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // alert(`âœ… RedÃ©marrage programmÃ© !\n\n${data.message}\n\nLa page se rechargera automatiquement dans 6 secondes.`);
                    // affiche une notification non bloquante
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000;';
                    notification.textContent = `âœ… RedÃ©marrage programmÃ© ! La page se rechargera automatiquement dans 6 secondes.`;
                    document.body.appendChild(notification);

                    // Attendre 6 secondes pour laisser le temps au service de redÃ©marrer
                    // (2s dÃ©lai + 3-4s pour le redÃ©marrage du service)
                    setTimeout(() => {
                        notification.remove();
                        location.reload();
                    }, 6000);
                } else {
                    alert(`âŒ Erreur lors du redÃ©marrage du service :\n\n${data.error}\n\nVous pouvez redÃ©marrer manuellement avec :\nsudo systemctl restart digital-signage.service`);
                }
            })
            .catch(error => {
                alert(`âŒ Erreur de connexion :\n\n${error.message}`);
            });
        }

        // Fermer les menus en cliquant ailleurs
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.screen-menu-btn')) {
                document.querySelectorAll('.screen-context-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
            if (!event.target.closest('.power-menu-btn') && !event.target.closest('.power-menu')) {
                document.getElementById('power-menu')?.classList.remove('active');
            }
        });

        // MENU POWER

        function togglePowerMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('power-menu');
            menu.classList.toggle('active');
        }

        function restartServiceFromMenu() {
            document.getElementById('power-menu').classList.remove('active');

            if (confirm('ğŸ”„ RedÃ©marrer le systÃ¨me ?\n\nTous les Ã©crans seront momentanÃ©ment dÃ©connectÃ©s puis reconnectÃ©s.')) {
                restartSystem();
            }
        }

        function stopServiceFromMenu() {
            document.getElementById('power-menu').classList.remove('active');

            if (confirm('âš ï¸ ATTENTION : ArrÃªter le systÃ¨me ?\n\nÃŠtes-vous sÃ»r de vouloir continuer ?')) {
                stopSystem();
            }
        }

        function stopSystem() {
            fetch('/stop-system', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher un message permanent car le systÃ¨me est arrÃªtÃ©
                    document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 24px; color: #dc3545;">ğŸ›‘ Le systÃ¨me est en cours d\'arrÃªt</div>';
                } else {
                    alert(`âŒ Erreur lors de l'arrÃªt du systÃ¨me :\n\n${data.error}`);
                }
            })
            .catch(error => {
                alert(`âŒ Erreur de connexion :\n\n${error.message}`);
            });
        }

        function restartSystem() {
            fetch('/restart-system', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // alert(`âœ… RedÃ©marrage programmÃ© !\n\n${data.message}\n\nLa page se rechargera automatiquement dans 6 secondes.`);
                    // affiche une notification non bloquante
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000;';
                    notification.textContent = `âœ… RedÃ©marrage programmÃ© ! La page se rechargera automatiquement dans 6 secondes.`;
                    document.body.appendChild(notification);

                    // Attendre 6 secondes pour laisser le temps au service de redÃ©marrer
                    // (2s dÃ©lai + 3-4s pour le redÃ©marrage du service)
                    setTimeout(() => {
                        notification.remove();
                        location.reload();
                    }, 6000);
                } else {
                    alert(`âŒ Erreur lors du redÃ©marrage du systÃ¨me :\n\n${data.error}`);
                }
            })
            .catch(error => {
                alert(`âŒ Erreur de connexion :\n\n${error.message}`);
            });
        }

        // CONFIGURATION Ã‰CRAN

        function openScreenConfig(screenId) {
            const screen = screens[screenId];
            document.getElementById('config-screen-id').value = screenId;

            // Remplir la liste des contenus disponibles
            const select = document.getElementById('config-default-content');
            select.innerHTML = '<option value="">Aucun (Ã©cran vide)</option>';
            contentLibrary.forEach(content => {
                const option = document.createElement('option');
                option.value = content.id;
                option.textContent = `${truncateText(content.name, 30)} (${getContentTypeText(content.type)})`;
                if (screen.default_content_id === content.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // DÃ©finir le comportement actuel
            document.getElementById('config-idle-behavior').value = screen.idle_behavior || 'show_default';

            // DÃ©finir l'option d'affichage de l'heure
            document.getElementById('config-show-clock').checked = screen.show_clock || false;

            document.getElementById('screen-config-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeScreenConfigModal() {
            document.getElementById('screen-config-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function saveScreenConfig() {
            const screenId = document.getElementById('config-screen-id').value;
            const defaultContentId = document.getElementById('config-default-content').value || null;
            const idleBehavior = document.getElementById('config-idle-behavior').value;
            const showClock = document.getElementById('config-show-clock').checked;

            socket.emit('update_screen_config', {
                screen_id: screenId,
                default_content_id: defaultContentId,
                idle_behavior: idleBehavior,
                show_clock: showClock
            });

            closeScreenConfigModal();
        }

        // PLANIFICATEUR

        function openScheduler(screenId) {
            document.getElementById('scheduler-screen-id').value = screenId;
            cancelScheduleEdit(); // RÃ©initialiser le mode Ã©dition
            updateSchedulerPlaylistSelect();
            updateCurrentSchedule(screenId);
            document.getElementById('scheduler-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeSchedulerModal() {
            cancelScheduleEdit(); // RÃ©initialiser le mode Ã©dition Ã  la fermeture
            document.getElementById('scheduler-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function updateSchedulerPlaylistSelect() {
            const select = document.getElementById('scheduler-playlist-select');
            select.innerHTML = '<option value="">Choisir une playlist...</option>';

            Object.values(playlists).forEach(playlist => {
                const option = document.createElement('option');
                option.value = playlist.id;
                option.textContent = `${truncateText(playlist.name, 20)} (${playlist.items.length} contenus)`;
                option.title = `${playlist.name} (${playlist.items.length} contenus)`; // Afficher le nom complet au survol
                select.appendChild(option);
            });
        }

        function updateCurrentSchedule(screenId) {
            const container = document.getElementById('current-schedule-list');
            const screenSchedule = schedules[screenId] || [];

            if (screenSchedule.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucune plage horaire dÃ©finie</p>';
                return;
            }

            // Tri automatique par heure de dÃ©but (format 24h)
            screenSchedule.sort((a, b) => {
                return a.start.localeCompare(b.start);
            });

            container.innerHTML = '';
            screenSchedule.forEach((entry, index) => {
                const playlist = playlists[entry.playlist_id];
                const playlistNameFull = playlist ? playlist.name : 'Playlist supprimÃ©e';
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 8px 12px; margin-bottom: 6px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #667eea; font-size: 0.9em;';
                item.innerHTML = `
                    <div style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px;">
                        <strong style="color: #333; flex-shrink: 0;">${entry.start} - ${entry.end}</strong>
                        <span style="color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: help;" title="${playlistNameFull}">â€¢ ${playlistNameFull}</span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                        <button class="btn btn-edit" onclick="editScheduleEntry('${screenId}', ${index})" style="width: auto; padding: 4px 12px; font-size: 0.85em;">âœï¸ Ã‰diter</button>
                        <button class="btn btn-danger" onclick="removeScheduleEntry('${screenId}', ${index})" style="width: auto; padding: 4px 12px; font-size: 0.85em;">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function saveScheduleEntry() {
            const screenId = document.getElementById('scheduler-screen-id').value;
            const playlistId = document.getElementById('scheduler-playlist-select').value;
            const start = document.getElementById('scheduler-start').value;
            const end = document.getElementById('scheduler-end').value;

            if (!playlistId || !start || !end) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            // VÃ©rifier que l'heure de fin est aprÃ¨s l'heure de dÃ©but
            if (start >= end) {
                alert('âŒ Erreur : L\'heure de fin doit Ãªtre aprÃ¨s l\'heure de dÃ©but');
                return;
            }

            if (!schedules[screenId]) {
                schedules[screenId] = [];
            }

            // VÃ©rifier s'il y a un chevauchement avec une plage horaire existante
            // (sauf avec l'entrÃ©e qu'on est en train d'Ã©diter)
            for (let i = 0; i < schedules[screenId].length; i++) {
                // Si on est en mode Ã©dition, ignorer l'entrÃ©e qu'on Ã©dite
                if (editingScheduleEntry && i === editingScheduleEntry.index) {
                    continue;
                }

                const entry = schedules[screenId][i];
                // Deux plages se chevauchent si :
                // - La nouvelle commence avant la fin de l'existante ET
                // - La nouvelle se termine aprÃ¨s le dÃ©but de l'existante
                if (start < entry.end && end > entry.start) {
                    const existingPlaylist = playlists[entry.playlist_id];
                    const playlistName = existingPlaylist ? existingPlaylist.name : 'Playlist supprimÃ©e';
                    alert(`âŒ Conflit de plage horaire !\n\nLa plage ${start} - ${end} chevauche une plage existante :\n${entry.start} - ${entry.end} : ${playlistName}\n\nVeuillez choisir une plage horaire diffÃ©rente.`);
                    return;
                }
            }

            // Si on est en mode Ã©dition, modifier l'entrÃ©e existante
            if (editingScheduleEntry) {
                schedules[screenId][editingScheduleEntry.index] = {
                    playlist_id: playlistId,
                    start: start,
                    end: end
                };
            } else {
                // Sinon, ajouter une nouvelle entrÃ©e
                schedules[screenId].push({
                    playlist_id: playlistId,
                    start: start,
                    end: end
                });
            }

            // Tri automatique par heure de dÃ©but (format 24h)
            schedules[screenId].sort((a, b) => {
                return a.start.localeCompare(b.start);
            });

            socket.emit('update_schedule', {
                screen_id: screenId,
                schedule: schedules[screenId]
            });

            // RÃ©initialiser le formulaire et le mode Ã©dition
            document.getElementById('scheduler-playlist-select').value = '';
            document.getElementById('scheduler-start').value = '';
            document.getElementById('scheduler-end').value = '';
            cancelScheduleEdit();

            updateCurrentSchedule(screenId);
        }

        function editScheduleEntry(screenId, index) {
            const entry = schedules[screenId][index];

            // PrÃ©-remplir le formulaire
            document.getElementById('scheduler-playlist-select').value = entry.playlist_id;
            document.getElementById('scheduler-start').value = entry.start;
            document.getElementById('scheduler-end').value = entry.end;

            // Activer le mode Ã©dition
            editingScheduleEntry = { screenId, index };

            // Changer le titre et le bouton
            document.getElementById('scheduler-form-title').textContent = 'âœï¸ Modifier la plage horaire';
            document.getElementById('scheduler-submit-btn').innerHTML = 'ğŸ’¾ Enregistrer les modifications';
            document.getElementById('scheduler-cancel-edit-btn').style.display = 'block';

            // Scroll vers le formulaire
            document.getElementById('scheduler-form-title').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function cancelScheduleEdit() {
            // RÃ©initialiser le mode Ã©dition
            editingScheduleEntry = null;

            // Restaurer le titre et le bouton
            document.getElementById('scheduler-form-title').textContent = 'Ajouter une plage horaire';
            document.getElementById('scheduler-submit-btn').innerHTML = '+ Ajouter au Planning';
            document.getElementById('scheduler-cancel-edit-btn').style.display = 'none';

            // Vider les champs
            document.getElementById('scheduler-playlist-select').value = '';
            document.getElementById('scheduler-start').value = '';
            document.getElementById('scheduler-end').value = '';
        }

        function removeScheduleEntry(screenId, index) {
            schedules[screenId].splice(index, 1);
            socket.emit('update_schedule', {
                screen_id: screenId,
                schedule: schedules[screenId]
            });
            updateCurrentSchedule(screenId);
        }

        function openAddContentModal() {
            document.getElementById('content-modal-title').textContent = 'ğŸ¬ Ajouter un Contenu';
            document.getElementById('content-id').value = '';
            document.getElementById('content-name').value = '';
            document.getElementById('content-type').value = 'url';
            document.getElementById('content-url').value = '';
            document.getElementById('content-duration').value = '00:00:10';
            document.getElementById('duration-error').style.display = 'none';
            document.getElementById('content-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function editContent(contentId) {
            const content = contentLibrary.find(c => c.id === contentId);
            if (!content) return;

            document.getElementById('content-modal-title').textContent = 'âœï¸ Ã‰diter le Contenu';
            document.getElementById('content-id').value = content.id;
            document.getElementById('content-name').value = content.name;
            document.getElementById('content-type').value = content.type;
            document.getElementById('content-url').value = content.url;
            // Si la durÃ©e est 0, mettre une valeur par dÃ©faut
            const durationValue = content.duration > 0 ? secondsToTimeInput(content.duration) : '00:00:10';
            document.getElementById('content-duration').value = durationValue;
            document.getElementById('duration-error').style.display = 'none';
            document.getElementById('content-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeContentModal() {
            document.getElementById('content-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            // RÃ©initialiser les messages d'erreur/loading
            document.getElementById('youtube-loading').style.display = 'none';
            document.getElementById('youtube-error').style.display = 'none';
            document.getElementById('duration-error').style.display = 'none';
            // RÃ©initialiser l'upload d'image
            uploadedImageUrl = null;
            document.getElementById('image-file').value = '';
            document.getElementById('upload-status').innerHTML = '';
            document.getElementById('image-upload-group').style.display = 'none';
            document.getElementById('image-or-separator').style.display = 'none';
        }

        function validateDuration() {
            const durationInput = document.getElementById('content-duration').value;
            const errorDiv = document.getElementById('duration-error');
            const duration = hmsToSeconds(durationInput);

            if (duration <= 0) {
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        async function handleYoutubeUrl() {
            const url = document.getElementById('content-url').value;
            const type = document.getElementById('content-type').value;
            const loadingDiv = document.getElementById('youtube-loading');
            const errorDiv = document.getElementById('youtube-error');

            // Cacher les messages
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            // VÃ©rifier si c'est une URL YouTube et si le type est youtube
            if (type !== 'youtube' || !url) {
                return;
            }

            // Extraire l'ID de la vidÃ©o
            const videoIdMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);
            if (!videoIdMatch) {
                errorDiv.textContent = 'âš ï¸ URL YouTube invalide';
                errorDiv.style.display = 'block';
                return;
            }

            const videoId = videoIdMatch[1];
            loadingDiv.style.display = 'block';

            try {
                const response = await fetch(`/api/youtube-metadata/${videoId}`);
                const data = await response.json();

                if (response.ok) {
                    // Mettre Ã  jour les champs
                    const nameField = document.getElementById('content-name');
                    const durationField = document.getElementById('content-duration');

                    // Ne remplacer le nom que s'il est vide
                    if (!nameField.value || nameField.value === '') {
                        nameField.value = data.title;
                    }

                    durationField.value = secondsToTimeInput(data.duration);
                    loadingDiv.style.display = 'none';

                    // Afficher un message de succÃ¨s temporaire
                    loadingDiv.textContent = 'âœ… MÃ©tadonnÃ©es rÃ©cupÃ©rÃ©es avec succÃ¨s';
                    loadingDiv.style.color = '#28a745';
                    loadingDiv.style.display = 'block';
                    setTimeout(() => {
                        loadingDiv.style.display = 'none';
                        loadingDiv.textContent = 'ğŸ”„ RÃ©cupÃ©ration des mÃ©tadonnÃ©es YouTube...';
                        loadingDiv.style.color = '#667eea';
                    }, 3000);
                } else {
                    errorDiv.textContent = `âš ï¸ ${data.error || 'Erreur lors de la rÃ©cupÃ©ration des mÃ©tadonnÃ©es'}`;
                    if (data.help) {
                        errorDiv.textContent += ` - ${data.help}`;
                    }
                    errorDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                }
            } catch (error) {
                errorDiv.textContent = 'âš ï¸ Erreur de connexion au serveur';
                errorDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
            }
        }

        let uploadedImageUrl = null;

        function toggleImageUpload() {
            const type = document.getElementById('content-type').value;
            const urlGroup = document.getElementById('url-group');
            const uploadGroup = document.getElementById('image-upload-group');
            const orSeparator = document.getElementById('image-or-separator');

            if (type === 'image') {
                uploadGroup.style.display = 'block';
                orSeparator.style.display = 'block';
            } else {
                uploadGroup.style.display = 'none';
                orSeparator.style.display = 'none';
                uploadedImageUrl = null;
                document.getElementById('image-file').value = '';
                document.getElementById('upload-status').innerHTML = '';
            }
        }

        async function handleImageUpload() {
            const fileInput = document.getElementById('image-file');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('upload-status');

            if (!file) {
                return;
            }

            statusDiv.innerHTML = '<span style="color: #667eea;">â³ Upload en cours...</span>';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    uploadedImageUrl = data.url;
                    statusDiv.innerHTML = `<span style="color: #28a745;">âœ… Image uploadÃ©e: ${data.filename}></span>`;

                    // PrÃ©-remplir le nom si vide
                    const nameInput = document.getElementById('content-name');
                    if (!nameInput.value) {
                        nameInput.value = data.filename.split('_')[0];
                    }

                    // Effacer l'URL si elle Ã©tait remplie
                    document.getElementById('content-url').value = '';
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Erreur: ${data.error}</span>`;
                    uploadedImageUrl = null;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Erreur de connexion: ${error.message}</span>`;
                uploadedImageUrl = null;
            }
        }

        function saveContent() {
            const contentId = document.getElementById('content-id').value;
            const name = document.getElementById('content-name').value;
            const type = document.getElementById('content-type').value;
            let url = document.getElementById('content-url').value;
            const durationInput = document.getElementById('content-duration').value;
            const duration = hmsToSeconds(durationInput);

            // Si c'est une image et qu'une image a Ã©tÃ© uploadÃ©e, utiliser l'URL uploadÃ©e
            if (type === 'image' && uploadedImageUrl) {
                url = uploadedImageUrl;
            }

            if (!name || !url) {
                alert('Veuillez remplir tous les champs (nom et URL ou fichier)');
                return;
            }

            if (duration <= 0) {
                alert('âŒ Erreur : La durÃ©e doit Ãªtre supÃ©rieure Ã  0.\n\nVeuillez dÃ©finir une durÃ©e valide (ex: 00:00:10).');
                document.getElementById('duration-error').style.display = 'block';
                return;
            }

            const contentData = {
                id: contentId || 'content_' + Date.now(),
                name: name,
                type: type,
                url: url,
                duration: duration
            };

            if (contentId) {
                socket.emit('update_content', contentData);
            } else {
                socket.emit('add_content', contentData);
            }

            closeContentModal();
        }

        function deleteContent(contentId) {
            const content = contentLibrary.find(c => c.id === contentId);
            if (confirm(`Supprimer "${content.name}" ?`)) {
                socket.emit('delete_content', { content_id: contentId });
            }
        }

        // DEBUG MODAL

        let debugScreenId = null;
        let debugInterval = null;

        function openDebugModal(screenId) {
            debugScreenId = screenId;
            const screen = screens[screenId];

            if (!screen) return;

            const debugScreenNameElement = document.getElementById('debug-screen-name');
            debugScreenNameElement.textContent = truncateText(screen.name, 25);
            debugScreenNameElement.title = screen.name;
            document.getElementById('debug-modal').classList.add('active');
            document.body.classList.add('modal-open');

            // RafraÃ®chir immÃ©diatement
            updateDebugInfo();

            // RafraÃ®chir toutes les 2 secondes
            debugInterval = setInterval(updateDebugInfo, 2000);
        }

        function closeDebugModal() {
            document.getElementById('debug-modal').classList.remove('active');
            document.body.classList.remove('modal-open');

            // ArrÃªter le rafraÃ®chissement
            if (debugInterval) {
                clearInterval(debugInterval);
                debugInterval = null;
            }

            debugScreenId = null;
        }

        function updateDebugInfo() {
            if (!debugScreenId || !screens[debugScreenId]) return;

            const screen = screens[debugScreenId];
            const schedule = schedules[debugScreenId] || [];

            // Ã‰tat actuel
            document.getElementById('debug-status').textContent = screen.status === 'online' ? 'ğŸŸ¢ En ligne' : 'ğŸ”´ Hors ligne';
            document.getElementById('debug-status').style.color = screen.status === 'online' ? '#28a745' : '#dc3545';

            // Utiliser les infos de debug pour avoir les vraies valeurs
            const debugInfo = screen.debug_info || {};
            const currentContentName = debugInfo.current_content_name || screen.current_content || 'Aucun';
            const debugCurrentContent = document.getElementById('debug-current-content');
            debugCurrentContent.textContent = currentContentName === 'Aucun' ? currentContentName : truncateText(currentContentName, 30);
            debugCurrentContent.title = currentContentName;

            // Playlist active
            const currentPlaylistName = debugInfo.current_playlist_name || screen.current_playlist || 'Aucune';
            const debugPlaylist = document.getElementById('debug-playlist');
            debugPlaylist.textContent = currentPlaylistName === 'Aucune' ? currentPlaylistName : truncateText(currentPlaylistName, 30);
            debugPlaylist.title = currentPlaylistName;
            document.getElementById('debug-playlist-index').textContent = debugInfo.playlist_index !== undefined
                ? `${debugInfo.playlist_index + 1}/${debugInfo.playlist_length || '?'}`
                : '--';

            // Temporisation
            if (debugInfo.elapsed_time !== undefined) {
                document.getElementById('debug-elapsed-time').textContent = secondsToHMS(Math.floor(debugInfo.elapsed_time));
            } else {
                document.getElementById('debug-elapsed-time').textContent = '--';
            }

            if (debugInfo.current_duration !== undefined) {
                document.getElementById('debug-total-duration').textContent = secondsToHMS(debugInfo.current_duration);
            } else {
                document.getElementById('debug-total-duration').textContent = '--';
            }

            document.getElementById('debug-last-seen').textContent = screen.last_seen || '--';

            // RÃ©seau
            const debugScreenIdElement = document.getElementById('debug-screen-id');
            debugScreenIdElement.textContent = truncateText(screen.id, 25);
            debugScreenIdElement.title = screen.id;

            const debugLocationElement = document.getElementById('debug-location');
            debugLocationElement.textContent = truncateText(screen.location, 25);
            debugLocationElement.title = screen.location;

            const debugSocketIdElement = document.getElementById('debug-socket-id');
            debugSocketIdElement.textContent = screen.sid ? screen.sid.substring(0, 12) + '...' : '--';
            debugSocketIdElement.title = screen.sid || '--';

            // Planning
            const scheduleContainer = document.getElementById('debug-schedule');
            if (schedule.length === 0) {
                scheduleContainer.innerHTML = '<div style="color: #999;">Aucun planning dÃ©fini</div>';
            } else {
                const now = new Date().toTimeString().slice(0, 5);
                let html = '';
                schedule.forEach(entry => {
                    const playlist = playlists[entry.playlist_id];
                    const isActive = entry.start <= now && now <= entry.end;
                    const playlistNameFull = playlist ? playlist.name : 'Playlist supprimÃ©e';
                    const playlistName = truncateText(playlistNameFull, 20);
                    html += `<div style="padding: 5px; ${isActive ? 'background: #d4edda; border-left: 3px solid #28a745;' : ''}" title="${playlistNameFull}">
                        ${entry.start} - ${entry.end}: ${playlistName}
                        ${isActive ? ' <strong style="color: #28a745;">â— ACTIF</strong>' : ''}
                    </div>`;
                });
                scheduleContainer.innerHTML = html;
            }
        }

        // PARAMÃˆTRES

        function openSettingsModal() {
            // Charger la clÃ© API actuelle
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('settings-youtube-api-key').value = data.youtube_api_key || '';
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des paramÃ¨tres:', error);
                });

            document.getElementById('settings-modal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            document.getElementById('settings-api-status').style.display = 'none';
        }

        function saveSettings() {
            const apiKey = document.getElementById('settings-youtube-api-key').value;
            const statusDiv = document.getElementById('settings-api-status');
            const statusText = document.getElementById('settings-api-status-text');

            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    youtube_api_key: apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusText.textContent = 'âœ… ParamÃ¨tres sauvegardÃ©s avec succÃ¨s !';
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusText.textContent = 'âŒ Erreur lors de la sauvegarde';
                }
                statusDiv.style.display = 'block';

                // Masquer le message aprÃ¨s 3 secondes
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Erreur:', error);
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusText.textContent = 'âŒ Erreur de connexion au serveur';
                statusDiv.style.display = 'block';
            });
        }

        // MISE Ã€ JOUR SYSTÃˆME

        let updateInfo = null;

        function openUpdateModal() {
            document.getElementById('update-modal').classList.add('active');
            document.body.classList.add('modal-open');
            // VÃ©rifier automatiquement les mises Ã  jour Ã  l'ouverture
            checkForUpdates();
        }

        function closeUpdateModal() {
            document.getElementById('update-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function checkForUpdates() {
            const checkBtn = document.getElementById('update-check-btn');
            const applyBtn = document.getElementById('update-apply-btn');
            const errorContainer = document.getElementById('update-error-container');
            const errorMessage = document.getElementById('update-error-message');
            const remoteInfo = document.getElementById('update-remote-info');
            const uptodateInfo = document.getElementById('update-uptodate-info');

            // DÃ©sactiver le bouton et afficher un Ã©tat de chargement
            checkBtn.disabled = true;
            checkBtn.textContent = 'ğŸ”„ VÃ©rification en cours...';
            applyBtn.style.display = 'none';
            errorContainer.style.display = 'none';
            remoteInfo.style.display = 'none';
            uptodateInfo.style.display = 'none';

            fetch('/api/check-update')
                .then(response => response.json())
                .then(data => {
                    updateInfo = data;

                    // Afficher le commit actuel
                    document.getElementById('update-current-commit').textContent = data.current_commit || '--';

                    if (data.error) {
                        errorMessage.textContent = data.error;
                        errorContainer.style.display = 'block';
                    } else if (data.available) {
                        // Une mise Ã  jour est disponible
                        document.getElementById('update-remote-commit').textContent = data.remote_commit || '--';
                        document.getElementById('update-commits-behind').textContent = data.commits_behind || '?';
                        document.getElementById('update-latest-message').textContent = data.latest_message || 'Pas de message';
                        remoteInfo.style.display = 'block';
                        applyBtn.style.display = 'block';

                        // Afficher le badge de mise Ã  jour dans le header
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'flex';
                    } else {
                        // Ã€ jour
                        uptodateInfo.style.display = 'block';
                        // Cacher le badge de mise Ã  jour
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'none';
                    }

                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ğŸ” VÃ©rifier les mises Ã  jour';
                })
                .catch(error => {
                    console.error('Erreur lors de la vÃ©rification des mises Ã  jour:', error);
                    errorMessage.textContent = 'Erreur de connexion au serveur';
                    errorContainer.style.display = 'block';
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ğŸ” VÃ©rifier les mises Ã  jour';
                });
        }

        function applyUpdate() {
            if (!updateInfo || !updateInfo.available) {
                alert('Aucune mise Ã  jour disponible');
                return;
            }

            if (!confirm(`Voulez-vous installer la mise Ã  jour ?\n\nCela va tÃ©lÃ©charger ${updateInfo.commits_behind} commit(s) depuis le dÃ©pÃ´t distant.`)) {
                return;
            }

            const applyBtn = document.getElementById('update-apply-btn');
            const checkBtn = document.getElementById('update-check-btn');
            const statusContainer = document.getElementById('update-status-container');
            const statusText = document.getElementById('update-status-text');
            const errorContainer = document.getElementById('update-error-container');
            const errorMessage = document.getElementById('update-error-message');

            // DÃ©sactiver les boutons et afficher un Ã©tat de chargement
            applyBtn.disabled = true;
            applyBtn.textContent = 'â¬‡ï¸ Installation en cours...';
            checkBtn.disabled = true;
            errorContainer.style.display = 'none';
            statusContainer.style.display = 'none';

            fetch('/api/apply-update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusContainer.style.background = '#d4edda';
                        statusContainer.style.color = '#155724';
                        statusText.innerHTML = `
                            âœ… Mise Ã  jour installÃ©e avec succÃ¨s !<br>
                            <div style="margin-top: 10px; font-size: 0.9em;">
                                <strong>Nouveau commit:</strong> <code>${data.new_commit}</code><br>
                                ${data.requires_restart ? '<strong style="color: #dc3545;">âš ï¸ RedÃ©marrage du serveur recommandÃ©</strong>' : ''}
                            </div>
                        `;
                        statusContainer.style.display = 'block';

                        // Cacher le badge de mise Ã  jour
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'none';

                        // Mettre Ã  jour l'affichage
                        document.getElementById('update-current-commit').textContent = data.new_commit;
                        document.getElementById('update-remote-info').style.display = 'none';
                        document.getElementById('update-uptodate-info').style.display = 'block';
                        applyBtn.style.display = 'none';

                        // Proposer de redÃ©marrer le service
                        if (confirm(`ğŸ”„ Voulez-vous redÃ©marrer le service digital-signage maintenant ?`)) {
                            restartService();
                        }
                        closeUpdateModal();
                    } else {
                        errorMessage.textContent = data.error || 'Erreur inconnue lors de l\'installation';
                        errorContainer.style.display = 'block';
                    }

                    applyBtn.disabled = false;
                    applyBtn.textContent = 'â¬‡ï¸ Installer la mise Ã  jour';
                    checkBtn.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur lors de l\'application de la mise Ã  jour:', error);
                    errorMessage.textContent = 'Erreur de connexion au serveur';
                    errorContainer.style.display = 'block';
                    applyBtn.disabled = false;
                    applyBtn.textContent = 'â¬‡ï¸ Installer la mise Ã  jour';
                    checkBtn.disabled = false;
                });
        }

        // VÃ©rification automatique au chargement de la page
        function checkForUpdatesOnLoad() {
            fetch('/api/check-update')
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        // Afficher le badge de mise Ã  jour
                        const updateBadge = document.getElementById('update-badge');
                        updateBadge.style.display = 'flex';
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la vÃ©rification automatique des mises Ã  jour:', error);
                });
            setTimeout(checkForUpdatesOnLoad, 60000); // VÃ©rifier toutes les minutes
        }

        // Auto-update
        socket.emit('get_state');

        // VÃ©rifier les mises Ã  jour au chargement de la page
        checkForUpdatesOnLoad();
    </script>
</body>
</html>